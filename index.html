<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ormkub æœƒå“¡å„€è¡¨æ¿</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-gradient: linear-gradient(135deg, #f6f8fb 0%, #eef2f3 100%);
        }
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: #444;
            padding-bottom: 60px;
        }
        .hidden { display: none !important; }
        
        /* å‹•ç•«æ•ˆæœ */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Loading é®ç½© */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .custom-card {
            border: none;
            border-radius: 16px;
            background: white;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            padding: 24px;
            margin-bottom: 20px;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-custom {
            background: var(--primary-color);
            color: white;
            border-radius: 50px;
            padding: 12px 0;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-custom:hover {
            background: #1a252f;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 62, 80, 0.3);
            color: white;
        }

        /* è³£å ´åˆ—è¡¨é …ç›® */
        .market-item {
            position: relative;
            padding-left: 15px;
            overflow: hidden;
        }
        .market-item::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 5px;
            background: var(--accent-color);
            border-radius: 4px 0 0 4px;
        }
        .status-badge {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
            background: #e8f4fc;
            color: var(--accent-color);
            font-weight: 700;
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3 fw-bold text-secondary" id="loading-text">ç³»çµ±é€£ç·šä¸­...</p>
    </div>

    <div id="app" class="container" style="max-width: 500px;">
        
        <div class="text-center mt-5 mb-4 fade-in">
            <h4 class="fw-bold" style="color:var(--primary-color);">
                <i class="bi bi-box-seam-fill me-2"></i>Ormkub 
            </h4>
            <p class="text-muted small">å°ˆå±¬æœƒå“¡æœå‹™ä¸­å¿ƒ</p>
        </div>

        <div id="register-view" class="custom-card fade-in hidden">
            <h5 class="text-center mb-4 fw-bold">æœƒå“¡ç¶å®š</h5>
            <div class="alert alert-light border small text-muted mb-4">
                <i class="bi bi-info-circle me-1"></i> è«‹å¡«å¯«æ‚¨åœ¨ç¤¾ç¾¤å…§çš„è³‡æ–™ä»¥åˆ©å°å¸³ã€‚
            </div>
            
            <form onsubmit="event.preventDefault(); doRegister();">
                <div class="form-floating mb-3">
                    <input type="email" id="reg-email" class="form-control" placeholder="name@example.com" required>
                    <label>Email (å¿…å¡«)</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" id="reg-name" class="form-control" placeholder="ç¾¤å…§åç¨±" required>
                    <label>ç¾¤å…§åç¨± (å¿…é ˆå®Œå…¨ä¸€è‡´)</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="text" id="reg-receiver" class="form-control" placeholder="æ”¶ä»¶äºº" required>
                    <label>æ”¶ä»¶äººçœŸå¯¦å§“å</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="tel" id="reg-phone" class="form-control" placeholder="09xxxxxxxx" pattern="09\d{8}" required>
                    <label>æ‰‹æ©Ÿè™Ÿç¢¼ (09é–‹é ­)</label>
                </div>
                <div class="form-floating mb-4">
                    <input type="text" id="reg-store" class="form-control" placeholder="7-11é–€å¸‚" required>
                    <label>å¸¸ç”¨ 7-11 é–€å¸‚åç¨±</label>
                </div>
                <button type="submit" id="reg-btn" class="btn btn-custom w-100">ç¢ºèªç¶å®š</button>
            </form>
        </div>

        <div id="dashboard-view" class="hidden">
            <div class="custom-card fade-in mb-3" style="background: linear-gradient(135deg, #2c3e50, #4ca1af); color: white;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="opacity-75">Welcome back,</small>
                        <h4 class="fw-bold mb-0" id="user-name">Loading...</h4>
                        <div class="mt-2 badge bg-light text-dark bg-opacity-75" id="user-group">ä¸€èˆ¬æœƒå“¡</div>
                    </div>
                    <i class="bi bi-person-circle display-4 opacity-50"></i>
                </div>
            </div>

            <div class="d-flex gap-2 mb-3 fade-in" style="animation-delay: 0.1s;">
                <button class="btn btn-light flex-grow-1 shadow-sm border-0 py-3" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise d-block fs-4 text-primary mb-1"></i>
                    <span class="small text-muted">åˆ·æ–°</span>
                </button>
                <button class="btn btn-light flex-grow-1 shadow-sm border-0 py-3" onclick="showMsg('æç¤º', 'ç©åˆ†ç³»çµ±å»ºç½®ä¸­')">
                    <i class="bi bi-star d-block fs-4 text-warning mb-1"></i>
                    <span class="small text-muted">ç©åˆ†</span>
                </button>
                <button class="btn btn-light flex-grow-1 shadow-sm border-0 py-3" onclick="showMsg('æç¤º', 'å®¢æœåŠŸèƒ½å»ºç½®ä¸­')">
                    <i class="bi bi-headset d-block fs-4 text-success mb-1"></i>
                    <span class="small text-muted">å®¢æœ</span>
                </button>
            </div>

            <h6 class="text-muted ms-2 mb-3 fw-bold fade-in"><i class="bi bi-shop me-2"></i>å°ˆå±¬è³£å ´</h6>
            <div id="market-list" class="fade-in" style="animation-delay: 0.2s;">
                </div>
        </div>
    </div>

    <div class="modal fade" id="infoModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold" id="infoModalTitle">æç¤º</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-secondary" id="infoModalBody"></div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-primary rounded-pill px-4" data-bs-dismiss="modal">ç¢ºå®š</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ==========================================
        // âš™ï¸ ç³»çµ±è¨­å®š (è«‹ç¢ºä¿å¡«å…¥æ­£ç¢ºè³‡è¨Š)
        // ==========================================
        const CONFIG = {
            // è«‹æ›¿æ›æˆä½ å‰›å‰›éƒ¨ç½²çš„ GAS Web App ç¶²å€ (çµå°¾æ˜¯ /exec)
            API_URL: 'https://script.google.com/macros/s/AKfycbw69JlYcBV5vj0yFjxNN1GgiMcQt6xKuym0ANK1tvKdlbnvYTnQ4wgX_dX1IiWIcr08IQ/exec',
            
            // è«‹æ›¿æ›æˆä½ çš„ LIFF ID
            LIFF_ID: '2008947743-8h9hmMMW' 
        };

        // å…¨åŸŸè®Šæ•¸
        let currentUid = '';
        let currentUserData = null;

        // 1. åˆå§‹åŒ–ç³»çµ±
        window.addEventListener('load', async () => {
            console.log('ğŸš€ ç³»çµ±å•Ÿå‹•...');
            await initLIFF();
        });

        // 2. åˆå§‹åŒ– LIFF
        async function initLIFF() {
            try {
                await liff.init({ liffId: CONFIG.LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                currentUid = profile.userId;
                console.log('âœ… å–å¾—ç”¨æˆ¶:', profile.displayName, currentUid);
                
                // é–‹å§‹æª¢æŸ¥æœƒå“¡ç‹€æ…‹
                await checkUserStatus(currentUid);

            } catch (err) {
                console.error('âŒ LIFF Error:', err);
                hideLoading();
                showMsg('ç³»çµ±éŒ¯èª¤', 'LINE ç™»å…¥å¤±æ•—ï¼Œè«‹å˜—è©¦é‡æ–°é–‹å•Ÿç¶²é ã€‚\n' + err.message);
            }
        }

        // 3. æ ¸å¿ƒ API å‘¼å« (ä¸€å¾‹ä½¿ç”¨ POST JSON)
        async function callApi(action, payload = {}) {
            try {
                // å°±ç®—å¾Œç«¯æ”¯æ´ GETï¼Œæˆ‘å€‘é€™è£¡ä¹Ÿå¼·åˆ¶ç”¨ POST ä»¥ç¢ºä¿è³‡æ–™å®Œæ•´æ€§ (å°¤å…¶æ˜¯ä¸­æ–‡)
                // å‚³é€çš„æ˜¯ç´”æ–‡å­—å­—ä¸² (Stringified JSON)ï¼Œé€™æ˜¯æœ€å®‰å…¨çš„è·¨åŸŸåšæ³•
                const requestBody = JSON.stringify({
                    action: action,
                    payload: payload
                });

                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    mode: 'cors', // é—œéµ
                    body: requestBody
                    // âš ï¸ æ³¨æ„ï¼šä¸è¦åŠ  'Content-Type': 'application/json' headerï¼Œé€™æœƒè§¸ç™¼ Preflight å°è‡´å¤±æ•—
                    // GAS é è¨­æœƒæŠŠ POST body ç•¶ä½œ text/plain è™•ç†ï¼Œæˆ‘å€‘åœ¨å¾Œç«¯ç”¨ JSON.parse è§£æå³å¯
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                
                if (result.status === 'error') {
                    throw new Error(result.message);
                }

                return result.data;

            } catch (err) {
                console.error(`API [${action}] å¤±æ•—:`, err);
                throw err;
            }
        }

        // 4. æª¢æŸ¥æœƒå“¡ç‹€æ…‹æµç¨‹
        async function checkUserStatus(uid) {
            updateLoadingText('è®€å–æœƒå“¡è³‡æ–™...');
            try {
                const user = await callApi('checkUser', { uid: uid });
                
                hideLoading();
                
                if (user) {
                    // å·²è¨»å†Š -> é€²å…¥å„€è¡¨æ¿
                    currentUserData = user;
                    renderDashboard(user);
                } else {
                    // æœªè¨»å†Š -> é¡¯ç¤ºè¨»å†Šè¡¨å–®
                    showView('register-view');
                }
            } catch (err) {
                hideLoading();
                showMsg('é€£ç·šéŒ¯èª¤', 'ç„¡æ³•è®€å–è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦ã€‚\n' + err.message);
            }
        }

        // 5. åŸ·è¡Œè¨»å†Š
        async function doRegister() {
            const email = document.getElementById('reg-email').value.trim();
            const name = document.getElementById('reg-name').value.trim();
            const receiver = document.getElementById('reg-receiver').value.trim();
            const phone = document.getElementById('reg-phone').value.trim();
            const store = document.getElementById('reg-store').value.trim();
            const btn = document.getElementById('reg-btn');

            if (!email || !name || !receiver || !phone || !store) return;

            // é–å®šæŒ‰éˆ•
            btn.disabled = true;
            btn.textContent = 'è™•ç†ä¸­...';
            showLoading('æ­£åœ¨ç¶å®šå¸³è™Ÿ...');

            try {
                const payload = {
                    uid: currentUid,
                    email, name, receiver, phone, store
                };

                await callApi('register', payload);
                
                // è¨»å†ŠæˆåŠŸï¼Œé‡æ–°æª¢æŸ¥ç‹€æ…‹
                await checkUserStatus(currentUid);
                
            } catch (err) {
                hideLoading();
                btn.disabled = false;
                btn.textContent = 'ç¢ºèªç¶å®š';
                showMsg('è¨»å†Šå¤±æ•—', err.message);
            }
        }

        // 6. æ¸²æŸ“å„€è¡¨æ¿ (å«è³£å ´åˆ—è¡¨)
        async function renderDashboard(user) {
            // å¡«å¯«åŸºæœ¬è³‡æ–™
            document.getElementById('user-name').textContent = user.name;
            document.getElementById('user-group').textContent = user.group_name || 'ä¸€èˆ¬æœƒå“¡';
            
            showView('dashboard-view');
            
            // è¼‰å…¥è³£å ´
            const listEl = document.getElementById('market-list');
            listEl.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <div class="spinner-border spinner-border-sm text-primary mb-2"></div>
                    <p class="small">æœå°‹å°ˆå±¬è³£å ´...</p>
                </div>
            `;

            try {
                const markets = await callApi('getMarkets', { uid: currentUid });
                listEl.innerHTML = ''; // æ¸…ç©º

                if (markets && markets.length > 0) {
                    markets.forEach((m, idx) => {
                        const html = `
                            <div class="custom-card market-item fade-in" style="animation-delay: ${idx * 0.1}s">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="fw-bold mb-0 text-dark">${m.sheetName}</h5>
                                    <span class="status-badge">${m.groupName}</span>
                                </div>
                                <p class="text-muted small mb-3">${m.desc || 'æš«ç„¡èªªæ˜'}</p>
                                <a href="${m.link}" target="_blank" class="btn btn-outline-primary w-100 rounded-pill">
                                    å‰å¾€é¸è³¼ <i class="bi bi-arrow-right-short"></i>
                                </a>
                            </div>
                        `;
                        listEl.insertAdjacentHTML('beforeend', html);
                    });
                } else {
                    listEl.innerHTML = `
                        <div class="custom-card text-center py-4">
                            <i class="bi bi-bag-x text-muted display-4 mb-3"></i>
                            <h6 class="fw-bold text-secondary">ç›®å‰æ²’æœ‰æ‚¨çš„å°ˆå±¬è³£å ´</h6>
                            <p class="small text-muted mb-0">è«‹ç¢ºèªæ‚¨çš„ç¾¤çµ„åç¨±è¨­å®šæ˜¯å¦æ­£ç¢ºï¼Œæˆ–ç¨å¾Œå†å›ä¾†æŸ¥çœ‹ã€‚</p>
                        </div>
                    `;
                }
            } catch (err) {
                listEl.innerHTML = `<div class="alert alert-danger small">è³£å ´è¼‰å…¥å¤±æ•—: ${err.message}</div>`;
            }
        }

        // --- å·¥å…·å‡½å¼ ---
        
        function showLoading(text = 'è¼‰å…¥ä¸­...') {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }

        function updateLoadingText(text) {
            document.getElementById('loading-text').textContent = text;
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        function showView(viewId) {
            document.getElementById('register-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
        }

        function showMsg(title, body) {
            document.getElementById('infoModalTitle').textContent = title;
            document.getElementById('infoModalBody').textContent = body;
            new bootstrap.Modal(document.getElementById('infoModal')).show();
        }

    </script>
</body>
</html>
