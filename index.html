<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>è¨‚å–®æŸ¥è©¢ï½œé…è²¨ & å°å¸³</title>
  <style>
    :root{
      --bg:#0b0c10;
      --card:#12131a;
      --muted:#a6a8b3;
      --text:#f3f4f6;
      --line:#242634;
      --ok:#2dd4bf;
      --warn:#fbbf24;
      --bad:#fb7185;
      --btn:#ffffff;
      --btnText:#0b0c10;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Heiti TC", "Microsoft JhengHei", Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 600px at 20% -10%, rgba(45,212,191,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(251,113,133,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{ color:inherit; }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 22px 16px 70px;
    }
    .header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      margin-bottom: 14px;
    }
    .title{
      line-height:1.15;
    }
    .title h1{
      margin:0;
      font-size: 24px;
      letter-spacing: .2px;
    }
    .title p{
      margin:6px 0 0;
      color:var(--muted);
      font-size: 13px;
    }
    .pill{
      font-family:var(--mono);
      font-size:12px;
      color:rgba(255,255,255,.85);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      padding: 8px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .panel{
      background: rgba(18,19,26,.92);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 14px;
      margin: 12px 0 16px;
      backdrop-filter: blur(6px);
    }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .input{
      flex: 1;
      min-width: 260px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      outline: none;
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: 15px;
    }
    .input::placeholder{ color: rgba(255,255,255,.45); }
    .btn{
      padding: 12px 14px;
      border: 0;
      border-radius: 14px;
      cursor: pointer;
      background: var(--btn);
      color: var(--btnText);
      font-weight: 700;
      letter-spacing:.2px;
      min-width: 120px;
    }
    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .hint{
      margin-top:10px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }
    .status{
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
    }

    .fileBlock{
      margin-top: 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      overflow:hidden;
    }
    .fileHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .fileName{
      font-weight: 800;
      letter-spacing:.2px;
    }
    .fileMeta{
      color: var(--muted);
      font-size: 12px;
      font-family: var(--mono);
    }
    .orders{
      padding: 12px 14px 16px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .orderCard{
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      background: rgba(18,19,26,.80);
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .orderTop{
      padding: 12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .orderId{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.85);
      margin:0 0 4px;
    }
    .buyer{
      font-size: 16px;
      font-weight: 900;
      margin:0;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      white-space: nowrap;
    }
    .badge.ok{ border-color: rgba(45,212,191,.35); color: var(--ok); background: rgba(45,212,191,.10); }
    .badge.warn{ border-color: rgba(251,191,36,.35); color: var(--warn); background: rgba(251,191,36,.10); }
    .badge.bad{ border-color: rgba(251,113,133,.35); color: var(--bad); background: rgba(251,113,133,.10); }

    .orderBody{
      padding: 12px 14px 14px;
    }
    .kv{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap: 8px 12px;
      padding: 10px 0;
      border-bottom: 1px dashed rgba(255,255,255,.12);
      font-size: 13px;
    }
    .kv:last-child{ border-bottom: 0; padding-bottom: 0; }
    .k{ color: var(--muted); }
    .v{ color: rgba(255,255,255,.92); }
    .v.mono{ font-family: var(--mono); font-size: 12.5px; }

    .sectionTitle{
      margin: 14px 0 8px;
      font-size: 13px;
      color: rgba(255,255,255,.88);
      font-weight: 800;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
    }
    .table th, .table td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      vertical-align: top;
      font-size: 13px;
    }
    .table th{
      text-align:left;
      color: rgba(255,255,255,.80);
      background: rgba(255,255,255,.04);
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .2px;
    }
    .table tr:last-child td{ border-bottom:0; }
    .muted{ color: var(--muted); }
    .empty{
      padding: 10px 12px;
      border: 1px dashed rgba(255,255,255,.16);
      border-radius: 14px;
      color: var(--muted);
      font-size: 13px;
    }

    .footerNote{
      margin-top: 16px;
      color: rgba(255,255,255,.55);
      font-size: 12px;
      line-height: 1.45;
    }

    @media (max-width: 540px){
      .kv{ grid-template-columns: 120px 1fr; }
      .btn{ width:100%; }
      .input{ width:100%; }
      .orderTop{ flex-direction: column; align-items:flex-start; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">
        <h1>è¨‚å–®æŸ¥è©¢ï½œé…è²¨ & å°å¸³</h1>
        <p>è¼¸å…¥ Email å¾ŒæŸ¥è©¢ï¼šæœƒåˆ°è³‡æ–™å¤¾å…§æ¯å€‹è¨‚å–®è©¦ç®—è¡¨çš„ã€Œç·¨è™Ÿé…ç½® / é…è²¨ / å°å¸³è¡¨ã€æŠ“å–è³‡æ–™ã€‚</p>
      </div>
      <div class="pill">JSONP Â· Web App API</div>
    </div>

    <div class="panel">
      <div class="row">
        <input id="emailInput" class="input" type="email" placeholder="è«‹è¼¸å…¥ Emailï¼ˆä¾‹å¦‚ï¼šname@gmail.comï¼‰" autocomplete="email" />
        <button id="searchBtn" class="btn">æŸ¥è©¢</button>
      </div>
      <div class="hint">
        â€¢ æŸ¥è©¢æœƒè‡ªå‹•è¨˜éŒ„åˆ° <span class="muted">Users</span> å·¥ä½œè¡¨ï¼ˆemail / uid / æ™‚é–“ï¼‰<br/>
        â€¢ å¦‚æœä½ ä¹‹å¾Œæ¥ä¸Š LIFFï¼Œå°‡ <span class="muted">CURRENT_UID</span> å¡«å…¥å³å¯ï¼ˆå¯é¸ï¼‰
      </div>
      <div id="status" class="status"></div>
    </div>

    <div id="results"></div>

    <div class="footerNote">
      æ³¨æ„ï¼šè‹¥è³‡æ–™é‡éå¸¸å¤§ï¼ˆè³‡æ–™å¤¾å…§è©¦ç®—è¡¨å¾ˆå¤šã€æ¯å¼µè¡¨å¾ˆå¤šåˆ—ï¼‰ï¼Œé¦–æ¬¡æŸ¥è©¢å¯èƒ½è¼ƒä¹…ã€‚è‹¥é‡åˆ°æŸ¥ä¸åˆ°ï¼Œè«‹å…ˆç¢ºèªã€Œç·¨è™Ÿé…ç½®ã€D æ¬„ Email æ˜¯å¦å®Œå…¨ä¸€è‡´ï¼ˆå¤§å°å¯«ä¸å½±éŸ¿ï¼Œä½†ç©ºç™½æœƒå½±éŸ¿ï¼‰ã€‚
    </div>
  </div>

  <script>
    // âœ… ä½ çš„æ–°éƒ¨ç½² /exec
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyRYlpBD7-Vdnq1cvp_lDin3Tq_7L78X83vQTa7M3kXEX9g-PVhstIJcpO5RdCTtQMN/exec";

    // âœ… è‹¥è¦ç”¨ LINE UID è‡ªå‹•æŸ¥è©¢ï¼šè«‹æŠŠä½ çš„ LIFF ID å¡«åœ¨é€™è£¡ï¼ˆä¸¦ç”¨ LIFF é–‹å•Ÿæ­¤é ï¼‰
    // ä¾‹å¦‚ï¼šconst LIFF_ID = "165xxxxxxx-XXXXXXXX";
    const LIFF_ID = "2008825521-dLeF3YrA";

    // ï¼ˆæ¸¬è©¦ç”¨ï¼‰ä¹Ÿå¯åœ¨ç¶²å€å¸¶å…¥ ?uid=Uxxxxxxxx ä¾†æ¨¡æ“¬ CURRENT_UID
    const urlParams = new URLSearchParams(location.search);
    const UID_FROM_URL = (urlParams.get("uid") || "").trim();

    let CURRENT_UID = UID_FROM_URL || "";

    const $ = (id) => document.getElementById(id);

    function setStatus(msg) {
      $("status").textContent = msg || "";
    }

    function setEmailInputEnabled(enabled) {
      const input = $("emailInput");
      input.disabled = !enabled;
      input.style.opacity = enabled ? "1" : "0.6";
    }

    function setEmailInputVisible(visible) {
      const input = $("emailInput");
      input.style.display = visible ? "" : "none";
    }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email || "").trim());
    }

    function fmtMoney(v) {
      if (v === "" || v === null || v === undefined) return "";
      const n = Number(v);
      return Number.isFinite(n) ? n.toLocaleString("en-US") : String(v);
    }

    function normalizeText(v) {
      return String(v ?? "").trim();
    }

    function normalizeOrderId(v) {
      return String(v ?? "").trim();
    }

    function statusBadge(payStatus) {
      const s = normalizeText(payStatus);
      const low = s.toLowerCase();
      if (!s) return `<span class="badge warn">ä»˜æ¬¾ç‹€æ…‹ï¼šæœªå¡«</span>`;
      if (low.includes("å·²") || low.includes("å®Œæˆ") || low.includes("paid") || low.includes("ok")) {
        return `<span class="badge ok">ä»˜æ¬¾ç‹€æ…‹ï¼š${escapeHtml(s)}</span>`;
      }
      if (low.includes("æœª") || low.includes("å¾…") || low.includes("æ¬ ") || low.includes("pending")) {
        return `<span class="badge warn">ä»˜æ¬¾ç‹€æ…‹ï¼š${escapeHtml(s)}</span>`;
      }
      return `<span class="badge warn">ä»˜æ¬¾ç‹€æ…‹ï¼š${escapeHtml(s)}</span>`;
    }

    /** JSONP call */
    function jsonpCall(action, params = {}) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Date.now() + "_" + Math.random().toString(16).slice(2);
        params.action = action;
        params.callback = cb;

        const url = WEBAPP_URL + "?" + new URLSearchParams(params).toString();

        const script = document.createElement("script");
        const timer = setTimeout(() => {
          cleanup();
          reject(new Error("JSONP timeout"));
        }, 20000);

        function cleanup() {
          clearTimeout(timer);
          try { delete window[cb]; } catch (_) { window[cb] = undefined; }
          if (script.parentNode) script.parentNode.removeChild(script);
        }

        window[cb] = (data) => { cleanup(); resolve(data); };
        script.onerror = () => { cleanup(); reject(new Error("JSONP load error")); };
        script.src = url;
        document.body.appendChild(script);
      });
    }

    /** Group API result -> by file -> by orderId */
    function buildOrderIndex(apiRes) {
      const fileBlocks = [];

      for (const pack of (apiRes.results || [])) {
        if (pack.error) {
          fileBlocks.push({
            fileName: pack.fileName || "ï¼ˆæœªå‘½åï¼‰",
            fileId: pack.fileId || "",
            error: pack.error,
            orders: []
          });
          continue;
        }

        const orderMap = new Map();
        const orderIds = (pack.orderIds || []).map(normalizeOrderId).filter(Boolean);

        // from mapping buyers array (same index as orderIds)
        const buyers = (pack.buyers || []).map(normalizeText);

        for (let i = 0; i < orderIds.length; i++) {
          const oid = orderIds[i];
          if (!orderMap.has(oid)) {
            orderMap.set(oid, {
              è¨‚å–®ç·¨è™Ÿ: oid,
              è¨‚è³¼äºº: buyers[i] || "",
              å°å¸³: null,
              é…è²¨: []
            });
          } else {
            // if repeated oid, keep buyer if empty
            const o = orderMap.get(oid);
            if (!o.è¨‚è³¼äºº && buyers[i]) o.è¨‚è³¼äºº = buyers[i];
          }
        }

        // attach å°å¸³ rows
        const billRows = (pack["å°å¸³è¡¨"] && pack["å°å¸³è¡¨"].rows) ? pack["å°å¸³è¡¨"].rows : [];
        for (const r of billRows) {
          const oid = normalizeOrderId(r["è¨‚å–®ç·¨è™Ÿ"]);
          if (!oid) continue;
          if (!orderMap.has(oid)) {
            orderMap.set(oid, { è¨‚å–®ç·¨è™Ÿ: oid, è¨‚è³¼äºº: normalizeText(r["è¨‚è³¼äºº"]), å°å¸³: r, é…è²¨: [] });
          } else {
            const o = orderMap.get(oid);
            if (!o.è¨‚è³¼äºº && r["è¨‚è³¼äºº"]) o.è¨‚è³¼äºº = normalizeText(r["è¨‚è³¼äºº"]);
            // if multiple reconcile rows exist, keep the first non-empty, else overwrite
            if (!o.å°å¸³) o.å°å¸³ = r;
          }
        }

        // attach é…è²¨ rows
        const shipRows = (pack["é…è²¨"] && pack["é…è²¨"].rows) ? pack["é…è²¨"].rows : [];
        for (const r of shipRows) {
          const oid = normalizeOrderId(r["è¨‚å–®ç·¨è™Ÿ"]);
          if (!oid) continue;
          if (!orderMap.has(oid)) {
            orderMap.set(oid, { è¨‚å–®ç·¨è™Ÿ: oid, è¨‚è³¼äºº: normalizeText(r["è¨‚è³¼äºº"]), å°å¸³: null, é…è²¨: [r] });
          } else {
            const o = orderMap.get(oid);
            if (!o.è¨‚è³¼äºº && r["è¨‚è³¼äºº"]) o.è¨‚è³¼äºº = normalizeText(r["è¨‚è³¼äºº"]);
            o.é…è²¨.push(r);
          }
        }

        const orders = Array.from(orderMap.values())
          .sort((a,b) => a.è¨‚å–®ç·¨è™Ÿ.localeCompare(b.è¨‚å–®ç·¨è™Ÿ, "zh-Hant"));

        fileBlocks.push({
          fileName: pack.fileName || "ï¼ˆæœªå‘½åï¼‰",
          fileId: pack.fileId || "",
          error: "",
          orders
        });
      }

      return fileBlocks;
    }

    function render(apiRes) {
      const root = $("results");
      root.innerHTML = "";

      if (!apiRes || !apiRes.ok) {
        root.innerHTML = `
          <div class="panel" style="border-color: rgba(251,113,133,.35);">
            <div style="font-weight:900;">âŒ æŸ¥è©¢å¤±æ•—</div>
            <div class="status" style="color: rgba(251,113,133,.95); margin-top:6px;">
              ${escapeHtml(apiRes?.error || "æœªçŸ¥éŒ¯èª¤")}
            </div>
          </div>`;
        return;
      }

      const fileBlocks = buildOrderIndex(apiRes);

      if (!fileBlocks.length || fileBlocks.every(b => !b.orders.length && !b.error)) {
        root.innerHTML = `
          <div class="panel">
            <div style="font-weight:900;">æŸ¥ä¸åˆ°è³‡æ–™</div>
            <div class="status">å·²æƒæ ${apiRes.scannedFiles} ä»½æª”æ¡ˆï¼Œæœªæ‰¾åˆ°ç¬¦åˆçš„è¨‚å–®ç·¨è™Ÿã€‚</div>
          </div>`;
        return;
      }

      for (const block of fileBlocks) {
        const meta = block.fileId ? `ï¼ˆ${escapeHtml(block.fileId.slice(0,8))}â€¦ï¼‰` : "";
        const headHtml = `
          <div class="fileHead">
            <div class="fileName">ğŸ“„ ${escapeHtml(block.fileName)}</div>
            <div class="fileMeta">${block.orders.length} ç­†è¨‚å–® ${meta}</div>
          </div>`;

        let bodyHtml = "";

        if (block.error) {
          bodyHtml = `
            <div class="orders">
              <div class="empty">âš ï¸ ${escapeHtml(block.error)}</div>
            </div>`;
        } else {
          bodyHtml = `<div class="orders">
            ${block.orders.map(renderOrderCard).join("")}
          </div>`;
        }

        root.insertAdjacentHTML("beforeend", `
          <div class="fileBlock">
            ${headHtml}
            ${bodyHtml}
          </div>
        `);
      }
    }

    function renderOrderCard(o) {
      const bill = o.å°å¸³ || null;

      const payStatus = bill ? bill["ä»˜æ¬¾ç‹€æ…‹"] : "";
      const badge = statusBadge(payStatus);

      const buyer = normalizeText(o.è¨‚è³¼äºº) || (bill ? normalizeText(bill["è¨‚è³¼äºº"]) : "") || "ï¼ˆæœªå¡«è¨‚è³¼äººï¼‰";

      const billKv = bill ? `
        <div class="kv">
          <div class="k">è³¼è²·ç¸½ä»¶æ•¸</div><div class="v">${escapeHtml(bill["è³¼è²·ç¸½ä»¶æ•¸"] ?? "")}</div>
          <div class="k">æ‡‰æ”¶é‡‘é¡</div><div class="v mono">${escapeHtml(fmtMoney(bill["æ‡‰æ”¶é‡‘é¡"]))}</div>
          <div class="k">ä»˜æ¬¾ç‹€æ…‹</div><div class="v">${escapeHtml(bill["ä»˜æ¬¾ç‹€æ…‹"] ?? "")}</div>
          <div class="k">ä»˜æ¬¾æ—¥æœŸ</div><div class="v">${escapeHtml(bill["ä»˜æ¬¾æ—¥æœŸ"] ?? "")}</div>
          <div class="k">å¾Œäº”ç¢¼</div><div class="v mono">${escapeHtml(bill["å¾Œäº”ç¢¼"] ?? "")}</div>
          <div class="k">æ”¶æ¬¾é‡‘é¡</div><div class="v mono">${escapeHtml(fmtMoney(bill["æ”¶æ¬¾é‡‘é¡"]))}</div>
          <div class="k">å‚™è¨»</div><div class="v">${escapeHtml(bill["å‚™è¨»"] ?? "")}</div>
        </div>
      ` : `<div class="empty">æ²’æœ‰æ‰¾åˆ°æ­¤è¨‚å–®çš„ã€Œå°å¸³è¡¨ã€è³‡æ–™ã€‚</div>`;

      const shipRows = Array.isArray(o.é…è²¨) ? o.é…è²¨ : [];
      const shipTable = shipRows.length ? `
        <table class="table">
          <thead>
            <tr>
              <th style="width:46%;">è¨‚è³¼å•†å“</th>
              <th style="width:12%;">ç™»è¨˜</th>
              <th style="width:12%;">é…è²¨</th>
              <th style="width:30%;">é…è²¨çµæœ</th>
            </tr>
          </thead>
          <tbody>
            ${shipRows.map(r => `
              <tr>
                <td>${escapeHtml(r["è¨‚è³¼å•†å“"] ?? "")}</td>
                <td class="mono">${escapeHtml(r["ç™»è¨˜æ•¸é‡"] ?? "")}</td>
                <td class="mono">${escapeHtml(r["é…è²¨æ•¸é‡"] ?? "")}</td>
                <td>${escapeHtml(r["é…è²¨çµæœ"] ?? "")}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      ` : `<div class="empty">æ²’æœ‰æ‰¾åˆ°æ­¤è¨‚å–®çš„ã€Œé…è²¨ã€è³‡æ–™ã€‚</div>`;

      return `
        <div class="orderCard">
          <div class="orderTop">
            <div>
              <p class="orderId">è¨‚å–®ç·¨è™Ÿï¼š${escapeHtml(o.è¨‚å–®ç·¨è™Ÿ)}</p>
              <p class="buyer">${escapeHtml(buyer)}</p>
            </div>
            <div>${badge}</div>
          </div>

          <div class="orderBody">
            <div class="sectionTitle">ğŸ§¾ å°å¸³è³‡æ–™</div>
            ${billKv}

            <div class="sectionTitle">ğŸ“¦ é…è²¨æ˜ç´°</div>
            ${shipTable}
          </div>
        </div>
      `;
    }

    async function doSearch() {
      const email = String($("emailInput").value || "").trim();

      $("searchBtn").disabled = true;
      setStatus("æŸ¥è©¢ä¸­â€¦ï¼ˆæ­£åœ¨æƒæè³‡æ–™å¤¾å…§è©¦ç®—è¡¨ï¼‰");

      try {
        let res = null;

        // 1) æœ‰ LINE UID â†’ å„ªå…ˆç”¨ UID è‡ªå‹•æŸ¥ï¼ˆä¸ç”¨ emailï¼‰
        if (CURRENT_UID) {
          setEmailInputEnabled(false);
          res = await jsonpCall("searchByUid", { uid: CURRENT_UID });

          if (res && res.ok) {
            setStatus(`æŸ¥è©¢å®Œæˆï¼šæƒæ ${res.scannedFiles} ä»½æª”æ¡ˆï¼Œæ‰¾åˆ° ${res.matchedFiles} ä»½æœ‰è³‡æ–™ã€‚`);
            render(res);
            // å·²ç¶å®šæˆåŠŸå¾Œï¼Œemail å¯éš±è—ï¼ˆæƒ³ä¿ç•™ä¹Ÿå¯ä»¥æ”¹æˆ trueï¼‰
            setEmailInputVisible(false);
            return;
          }

          // UID æœ‰ï¼Œä½†å°šæœªç¶å®š email â†’ è®“ä½¿ç”¨è€…è¼¸å…¥ email ä¾†ç¶å®š
          setEmailInputVisible(true);
          setEmailInputEnabled(true);
          setStatus(res?.error || "æ­¤å¸³è™Ÿå°šæœªç¶å®š Emailï¼Œè«‹è¼¸å…¥ Email é€²è¡Œç¶å®šå¾Œå†æŸ¥è©¢ã€‚");
          $("emailInput").focus();
          return;
        }

        // 2) æ²’æœ‰ UID â†’ èµ°æ‰‹å‹• email æŸ¥
        setEmailInputVisible(true);
        setEmailInputEnabled(true);
        if (!isValidEmail(email)) {
          setStatus("è«‹è¼¸å…¥æ­£ç¢ºçš„ Email æ ¼å¼ã€‚");
          $("emailInput").focus();
          return;
        }

        res = await jsonpCall("search", { email });
        setStatus(res && res.ok
          ? `æŸ¥è©¢å®Œæˆï¼šæƒæ ${res.scannedFiles} ä»½æª”æ¡ˆï¼Œæ‰¾åˆ° ${res.matchedFiles} ä»½æœ‰è³‡æ–™ã€‚`
          : `æŸ¥è©¢å¤±æ•—ï¼š${res?.error || "æœªçŸ¥éŒ¯èª¤"}`
        );
        render(res);

      } catch (err) {
        setStatus("æŸ¥è©¢å¤±æ•—ï¼ˆé€£ç·šæˆ–éƒ¨ç½²æ¬Šé™å•é¡Œï¼‰ï¼š" + (err?.message || err));
        render({ ok:false, error: String(err?.message || err) });
      } finally {
        $("searchBtn").disabled = false;
      }
    }

    async function bindEmailAndSearch() {
      const email = String($("emailInput").value || "").trim();
      if (!CURRENT_UID) {
        setStatus("ç›®å‰æ²’æœ‰ LINE UIDï¼Œç„¡æ³•é€²è¡Œç¶å®šã€‚è«‹ç”¨ LIFF é–‹å•Ÿæ­¤é ã€‚");
        return;
      }
      if (!isValidEmail(email)) {
        setStatus("è«‹è¼¸å…¥æ­£ç¢ºçš„ Email æ ¼å¼ä»¥å®Œæˆç¶å®šã€‚");
        $("emailInput").focus();
        return;
      }

      $("searchBtn").disabled = true;
      setStatus("ç¶å®šä¸­â€¦");

      try {
        await jsonpCall("saveEmail", { email, uid: CURRENT_UID });
        setStatus("ç¶å®šå®Œæˆ âœ… æ­£åœ¨æŸ¥è©¢â€¦");
        const res = await jsonpCall("searchByUid", { uid: CURRENT_UID });

        setStatus(res && res.ok
          ? `æŸ¥è©¢å®Œæˆï¼šæƒæ ${res.scannedFiles} ä»½æª”æ¡ˆï¼Œæ‰¾åˆ° ${res.matchedFiles} ä»½æœ‰è³‡æ–™ã€‚`
          : `æŸ¥è©¢å¤±æ•—ï¼š${res?.error || "æœªçŸ¥éŒ¯èª¤"}`
        );
        render(res);
        if (res && res.ok) setEmailInputVisible(false);
      } catch (err) {
        setStatus("ç¶å®š/æŸ¥è©¢å¤±æ•—ï¼š" + (err?.message || err));
        render({ ok:false, error: String(err?.message || err) });
      } finally {
        $("searchBtn").disabled = false;
      }
    }

    // events
    $("searchBtn").addEventListener("click", async () => {
      // æœ‰ UID ä½†å°šæœªç¶å®šæ™‚ï¼Œä½¿ç”¨è€…è¼¸å…¥ email å¾Œï¼ŒæŒ‰æŒ‰éˆ•èµ°ã€Œç¶å®š + æŸ¥è©¢ã€
      if (CURRENT_UID) {
        // å…ˆè©¦ UID æŸ¥ï¼›è‹¥æˆåŠŸæœƒç›´æ¥é¡¯ç¤ºä¸¦ return
        const probe = await jsonpCall("searchByUid", { uid: CURRENT_UID }).catch(() => null);
        if (probe && probe.ok) {
          setStatus(`æŸ¥è©¢å®Œæˆï¼šæƒæ ${probe.scannedFiles} ä»½æª”æ¡ˆï¼Œæ‰¾åˆ° ${probe.matchedFiles} ä»½æœ‰è³‡æ–™ã€‚`);
          render(probe);
          setEmailInputVisible(false);
          return;
        }
        // probe å¤±æ•— â†’ è¦–ç‚ºéœ€è¦ç¶å®š
        await bindEmailAndSearch();
        return;
      }
      await doSearch();
    });
    $("emailInput").addEventListener("keydown", async (e) => {
      if (e.key === "Enter") {
        if (CURRENT_UID) {
          await bindEmailAndSearch();
        } else {
          await doSearch();
        }
      }
    });

    (async () => {
      try {
        const ping = await jsonpCall("ping", {});
        if (ping && ping.ok) setStatus("API å·²é€£ç·š âœ…");

        // è‹¥æœ‰ LIFF_IDï¼Œå°±å‹•æ…‹è¼‰å…¥ LIFF SDK ä¸¦å˜—è©¦å–å¾— userId
        if (LIFF_ID) {
          await new Promise((resolve, reject) => {
            const s = document.createElement("script");
            s.src = "https://static.line-scdn.net/liff/edge/2/sdk.js";
            s.onload = resolve;
            s.onerror = reject;
            document.head.appendChild(s);
          });

          await liff.init({ liffId: LIFF_ID });
          if (!liff.isLoggedIn()) {
            setStatus("éœ€è¦ç™»å…¥ LINE æ‰èƒ½è‡ªå‹•æŸ¥è©¢â€¦");
            liff.login();
            return;
          }
          const profile = await liff.getProfile();
          CURRENT_UID = (profile.userId || "").trim();
        }

        // æœ‰ UIDï¼ˆLIFF æˆ– URL åƒæ•¸ï¼‰å°±è‡ªå‹•æŸ¥
        if (CURRENT_UID) {
          setEmailInputEnabled(false);
          const res = await jsonpCall("searchByUid", { uid: CURRENT_UID });
          if (res && res.ok) {
            setStatus(`è‡ªå‹•æŸ¥è©¢å®Œæˆï¼šæƒæ ${res.scannedFiles} ä»½æª”æ¡ˆï¼Œæ‰¾åˆ° ${res.matchedFiles} ä»½æœ‰è³‡æ–™ã€‚`);
            render(res);
            setEmailInputVisible(false);
          } else {
            // å°šæœªç¶å®š â†’ é¡¯ç¤º email è¼¸å…¥
            setEmailInputVisible(true);
            setEmailInputEnabled(true);
            setStatus(res?.error || "æ­¤å¸³è™Ÿå°šæœªç¶å®š Emailï¼Œè«‹è¼¸å…¥ Email é€²è¡Œç¶å®šã€‚\nï¼ˆç¶å®šå¾Œä¸‹æ¬¡å°±ä¸ç”¨å†è¼¸å…¥ï¼‰");
          }
        } else {
          setEmailInputVisible(true);
          setEmailInputEnabled(true);
          setStatus("è«‹è¼¸å…¥ Email æŸ¥è©¢ï¼ˆæˆ–ç”¨ LIFF é–‹å•Ÿä»¥ä½¿ç”¨ UID è‡ªå‹•æŸ¥è©¢ï¼‰");
        }

      } catch {
        setStatus("API é€£ç·šæ¸¬è©¦å¤±æ•— âš ï¸ è«‹ç¢ºèª Web App éƒ¨ç½²æ¬Šé™ç‚ºã€ä»»ä½•äººã€");
        setEmailInputVisible(true);
        setEmailInputEnabled(true);
      }
    })();
  </script>
</body>
</html>
