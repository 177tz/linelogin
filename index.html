<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ormkub 會員儀表板</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); padding-bottom: 80px; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.3s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loading 畫面 (純文字版) */
        #loading-overlay { 
            position: fixed; inset: 0; background: #fff; z-index: 9999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
        
        /* 卡片樣式 */
        .dashboard-card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); padding: 20px; margin-bottom: 15px; }
        
        /* 2x2 選單 */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .menu-btn {
            background: white; border: none; border-radius: 12px; padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); display: flex; flex-direction: column; align-items: center;
            color: var(--primary); transition: 0.2s;
        }
        .menu-btn:active { transform: scale(0.96); background: #f8f9fa; }
        .menu-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(44, 62, 80, 0.3); }
        .menu-btn i { font-size: 1.8rem; margin-bottom: 5px; }

        /* 團購卡片 */
        .group-buy-card { border: 1px solid #eee; border-radius: 12px; overflow: hidden; margin-bottom: 20px; background: white; }
        .group-header { background: #f8f9fa; padding: 12px 15px; border-bottom: 1px solid #eee; font-weight: 700; color: var(--primary); }
        .detail-item { padding: 10px 15px; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; font-size: 0.9rem; }
        .summary-section { background: #fff; padding: 15px; border-top: 1px solid #eee; }

        /* 狀態標籤 */
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .bg-ok { background: #d4edda; color: #155724; }
        .bg-wait { background: #fff3cd; color: #856404; }
        .bg-err { background: #f8d7da; color: #721c24; }
        .bg-cod { background: #d1ecf1; color: #0c5460; }

        /* 個人資料列表 */
        .profile-item { padding: 12px 0; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; }
        .profile-label { color: #888; font-size: 0.9rem; }
        .profile-value { font-weight: 500; color: #333; text-align: right; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3 fw-bold text-secondary" id="loading-text">系統連線中...</p>
    </div>

    <div id="app" class="container" style="max-width: 500px;">
        
        <div class="text-center mt-5 mb-4 fade-in">
            <h3 class="fw-bold" style="color:var(--primary); letter-spacing: 1px;">ORMKUB</h3>
            <p class="small text-muted">Hi, <span id="header-name">Member</span></p>
        </div>

        <div id="register-view" class="dashboard-card hidden">
            <h5 class="text-center mb-3">會員綁定</h5>
            <form onsubmit="event.preventDefault(); doRegister();">
                <input type="email" id="reg-email" class="form-control mb-2" placeholder="Email" required>
                <input type="text" id="reg-name" class="form-control mb-2" placeholder="群內名稱 (重要)" required>
                <input type="text" id="reg-receiver" class="form-control mb-2" placeholder="收件人姓名" required>
                <input type="tel" id="reg-phone" class="form-control mb-2" placeholder="手機號碼" required>
                <input type="text" id="reg-store" class="form-control mb-3" placeholder="7-11 門市" required>
                <button class="btn btn-primary w-100 rounded-pill">送出綁定</button>
            </form>
        </div>

        <div id="dashboard-view" class="hidden">
            
            <div class="menu-grid fade-in">
                <button class="menu-btn" onclick="switchTab('profile', this)">
                    <i class="bi bi-person-vcard"></i><span class="small">資料</span>
                </button>
                <button class="menu-btn" onclick="switchTab('orders', this)">
                    <i class="bi bi-receipt"></i><span class="small">訂單</span>
                </button>
                <button class="menu-btn active" onclick="switchTab('markets', this)">
                    <i class="bi bi-shop"></i><span class="small">賣場</span>
                </button>
                <button class="menu-btn" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i><span class="small">刷新</span>
                </button>
            </div>

            <div id="content-area">
                
                <div id="tab-profile" class="content-section hidden">
                    <div class="dashboard-card fade-in">
                        <h6 class="border-bottom pb-2 mb-3 fw-bold text-secondary">基本資料</h6>
                        <div class="profile-item"><span class="profile-label">群內名稱</span><span class="profile-value" id="p-group"></span></div>
                        <div class="profile-item"><span class="profile-label">Email</span><span class="profile-value small" id="p-email"></span></div>
                        <div class="profile-item"><span class="profile-label">電話</span><span class="profile-value" id="p-phone"></span></div>
                        <div class="profile-item"><span class="profile-label">收件人</span><span class="profile-value" id="p-receiver"></span></div>
                        <div class="profile-item border-0"><span class="profile-label">門市</span><span class="profile-value" id="p-store"></span></div>
                    </div>
                    <div class="text-center px-3 fade-in">
                        <p class="text-muted small mb-2">如需修改資料，請聯絡官方 LINE</p>
                        <a href="https://ormkub.pse.is/LINEOA527" target="_blank" class="btn btn-outline-success btn-sm w-100 rounded-pill">
                            <i class="bi bi-line me-1"></i> 聯繫客服
                        </a>
                    </div>
                </div>

                <div id="tab-orders" class="content-section hidden">
                    <h6 class="ps-1 mb-3 text-secondary">訂購紀錄</h6>
                    <div id="orders-container"></div>
                </div>

                <div id="tab-markets" class="content-section fade-in">
                    <h6 class="mb-3 ps-1 text-secondary">專屬賣場</h6>
                    <div id="market-list"></div>
                </div>

            </div>
        </div>

    </div>

    <div class="modal fade" id="infoModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body text-center"><h5 id="m-title"></h5><p id="m-body"></p><button class="btn btn-primary btn-sm rounded-pill px-4" data-bs-dismiss="modal">OK</button></div></div></div></div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ==========================================
        // ⚙️ 設定檔
        // ==========================================
        const CONFIG = {
            API_URL: 'https://script.google.com/macros/s/AKfycbw69JlYcBV5vj0yFjxNN1GgiMcQt6xKuym0ANK1tvKdlbnvYTnQ4wgX_dX1IiWIcr08IQ/exec',
            LIFF_ID: '2008947743-8h9hmMMW' 
        };
        let currentUid = '';

        // 初始化
        window.onload = async () => {
            try {
                await liff.init({ liffId: CONFIG.LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                currentUid = (await liff.getProfile()).userId;
                await checkUser(currentUid);
            } catch (e) {
                document.getElementById('loading-text').innerText = '連線失敗: ' + e.message;
            }
        };

        // API
        async function callApi(act, pay={}) {
            const r = await fetch(CONFIG.API_URL, { method: 'POST', body: JSON.stringify({action: act, payload: pay}) });
            const j = await r.json();
            if (j.status === 'error') throw new Error(j.message);
            return j.data;
        }

        // 檢查用戶
        async function checkUser(uid) {
            try {
                const u = await callApi('checkUser', {uid});
                hideLoading();
                if (u) {
                    // Header Info
                    document.getElementById('header-name').innerText = u.name;
                    
                    // Profile Info
                    document.getElementById('p-group').innerText = u.group_name;
                    document.getElementById('p-email').innerText = u.email;
                    document.getElementById('p-phone').innerText = u.phone;
                    document.getElementById('p-receiver').innerText = u.name;
                    document.getElementById('p-store').innerText = u.store;

                    showView('dashboard-view');
                    loadMarkets(uid);
                } else { showView('register-view'); }
            } catch (e) { alert(e.message); }
        }

        // 註冊
        async function doRegister() {
            const vals = ['email','name','receiver','phone','store'].reduce((a,k)=>{a[k]=document.getElementById('reg-'+k).value;return a},{});
            showLoading();
            try { await callApi('register', {...vals, uid:currentUid}); location.reload(); }
            catch(e) { hideLoading(); alert(e.message); }
        }

        // 載入賣場
        async function loadMarkets(uid) {
            const div = document.getElementById('market-list');
            div.innerHTML = '<div class="text-center small text-muted py-4">載入中...</div>';
            try {
                const mkts = await callApi('getMarkets', {uid});
                div.innerHTML = mkts.length ? mkts.map(m => `
                    <div class="dashboard-card border-start border-4 border-primary p-3 fade-in">
                        <h6 class="fw-bold text-dark">${m.sheetName}</h6>
                        <p class="small text-muted mb-2">${m.desc||''}</p>
                        <a href="${m.link}" target="_blank" class="btn btn-primary btn-sm w-100 rounded-pill">前往下單</a>
                    </div>`).join('') : '<div class="text-center small text-muted py-4">無可用賣場</div>';
            } catch(e) { div.innerHTML = '載入失敗'; }
        }

        // 載入訂單
        async function loadOrders(uid) {
            const div = document.getElementById('orders-container');
            div.innerHTML = '<div class="text-center small text-muted py-4">同步資料中...</div>';
            try {
                const groups = await callApi('getOrders', {uid});
                if (!groups || groups.length === 0) {
                    div.innerHTML = '<div class="text-center py-5 text-muted">目前無訂單紀錄</div>';
                    return;
                }
                div.innerHTML = groups.map(g => {
                    // 明細
                    let details = (g.details&&g.details.length) ? g.details.map(d => `
                        <div class="detail-item">
                            <div>${d.item} <small class="text-muted">(${d.note})</small></div>
                            <span class="badge bg-secondary rounded-pill">x${d.qty}</span>
                        </div>`).join('') : '<div class="text-center small text-muted py-2">無明細</div>';
                    
                    // 對帳
                    let summary = (g.summary&&g.summary.length) ? g.summary.map(s => {
                        let cls = 'bg-wait';
                        if(s.status.includes('✅')||s.status.includes('核對')) cls = 'bg-ok';
                        else if(s.status.includes('❌')) cls = 'bg-err';
                        else if(s.status.includes('貨到')) cls = 'bg-cod';
                        return `
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <span class="small text-muted">應付總額: <strong class="text-dark">$${s.total}</strong></span>
                                <span class="status-badge ${cls}">${s.status}</span>
                            </div>`;
                    }).join('') : '<div class="text-center small text-muted py-2">尚無對帳</div>';

                    return `<div class="group-buy-card fade-in"><div class="group-header"><i class="bi bi-folder2-open me-2"></i>${g.groupName}</div><div>${details}</div><div class="summary-section">${summary}</div></div>`;
                }).join('');
            } catch(e) { div.innerHTML = '載入失敗'; }
        }

        function switchTab(tab, btn) {
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
            document.getElementById('tab-' + tab).classList.remove('hidden');
            if (tab === 'orders') loadOrders(currentUid);
        }

        function showView(id) {
            ['register-view', 'dashboard-view'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
        function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
    </script>
</body>
</html>
