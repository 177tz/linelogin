<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ormkub 會員儀表板</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f7f6; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); padding-bottom: 80px; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.96); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        .dashboard-card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); padding: 20px; margin-bottom: 15px; }
        .menu-btn {
            background: white; border: none; border-radius: 12px; padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); display: flex; flex-direction: column; align-items: center;
            color: var(--primary); transition: 0.2s;
        }
        .menu-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(44, 62, 80, 0.3); }
        .menu-btn i { font-size: 1.8rem; margin-bottom: 5px; }
        
        /* 訂單明細樣式 */
        .detail-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px dashed #eee;
        }
        .detail-item:last-child { border-bottom: none; }
        .batch-tag { font-size: 0.75rem; background: #eef2f3; color: #666; padding: 2px 8px; border-radius: 4px; margin-left: 8px; }

        /* 對帳狀態樣式 */
        .status-card { background: #fff; border-radius: 12px; padding: 15px; border-left: 5px solid #ccc; margin-top: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .status-ok { border-color: #2ecc71; }
        .status-wait { border-color: #f1c40f; }
        .status-cod { border-color: #3498db; }
        .status-err { border-color: #e74c3c; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3 small fw-bold text-secondary" id="loading-text">Loading...</p>
    </div>

    <div id="app" class="container" style="max-width: 500px;">
        <div class="text-center mt-4 mb-4">
            <h5 class="fw-bold" style="color:var(--primary);">Ormkub Dashboard</h5>
            <p class="small text-muted">Hi, <span id="header-name">...</span></p>
        </div>

        <div id="register-view" class="dashboard-card hidden">
            <h5 class="text-center mb-3">會員綁定</h5>
            <form onsubmit="event.preventDefault(); doRegister();">
                <input type="email" id="reg-email" class="form-control mb-2" placeholder="Email" required>
                <input type="text" id="reg-name" class="form-control mb-2" placeholder="群內名稱 (重要)" required>
                <input type="text" id="reg-receiver" class="form-control mb-2" placeholder="收件人姓名" required>
                <input type="tel" id="reg-phone" class="form-control mb-2" placeholder="手機號碼" required>
                <input type="text" id="reg-store" class="form-control mb-3" placeholder="7-11 門市" required>
                <button class="btn btn-primary w-100 rounded-pill">送出</button>
            </form>
        </div>

        <div id="dashboard-view" class="hidden">
            <div class="d-grid grid-template-columns gap-2 mb-4" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                <button class="menu-btn" onclick="switchTab('profile', this)"><i class="bi bi-person-vcard"></i><span class="small">資料</span></button>
                <button class="menu-btn" onclick="switchTab('orders', this)"><i class="bi bi-box-seam"></i><span class="small">訂單</span></button>
                <button class="menu-btn active" onclick="switchTab('markets', this)"><i class="bi bi-shop"></i><span class="small">賣場</span></button>
                <button class="menu-btn" onclick="location.reload()"><i class="bi bi-arrow-clockwise"></i><span class="small">刷新</span></button>
            </div>

            <div id="content-area">
                <div id="tab-profile" class="content-section hidden">
                    <div class="dashboard-card">
                        <h6 class="border-bottom pb-2 mb-3">會員檔案</h6>
                        <p class="mb-2"><strong>群組名稱:</strong> <span id="p-group"></span></p>
                        <p class="mb-2"><strong>姓名:</strong> <span id="p-name"></span></p>
                    </div>
                </div>

                <div id="tab-orders" class="content-section hidden">
                    
                    <h6 class="ps-1 mb-2 text-secondary"><i class="bi bi-list-ul me-2"></i>訂購明細</h6>
                    <div class="dashboard-card mb-4">
                        <div id="order-details-list">
                            </div>
                    </div>

                    <h6 class="ps-1 mb-2 text-secondary"><i class="bi bi-wallet2 me-2"></i>對帳/付款狀態</h6>
                    <div id="order-summary-list">
                        </div>
                </div>

                <div id="tab-markets" class="content-section">
                    <h6 class="mb-3 ps-1">專屬賣場</h6>
                    <div id="market-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="infoModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body text-center"><h5 id="m-title"></h5><p id="m-body"></p><button class="btn btn-primary btn-sm rounded-pill px-4" data-bs-dismiss="modal">OK</button></div></div></div></div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const CONFIG = {
            API_URL: 'https://script.google.com/macros/s/AKfycbw69JlYcBV5vj0yFjxNN1GgiMcQt6xKuym0ANK1tvKdlbnvYTnQ4wgX_dX1IiWIcr08IQ/exec',
            LIFF_ID: '2008947743-8h9hmMMW' 
        };
        let currentUid = '', currentUser = null;

        window.onload = async () => {
            try {
                await liff.init({ liffId: CONFIG.LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                currentUid = (await liff.getProfile()).userId;
                await checkUser(currentUid);
            } catch (e) { alert('系統錯誤: ' + e.message); hideLoading(); }
        };

        async function callApi(act, pay={}) {
            const r = await fetch(CONFIG.API_URL, { method: 'POST', body: JSON.stringify({action: act, payload: pay}) });
            const j = await r.json();
            if (j.status === 'error') throw new Error(j.message);
            return j.data;
        }

        async function checkUser(uid) {
            try {
                const u = await callApi('checkUser', {uid});
                hideLoading();
                if (u) {
                    currentUser = u;
                    document.getElementById('header-name').innerText = u.name;
                    document.getElementById('p-group').innerText = u.group_name;
                    document.getElementById('p-name').innerText = u.name;
                    showView('dashboard-view');
                    loadMarkets(uid); 
                } else { showView('register-view'); }
            } catch (e) { alert(e.message); }
        }

        async function doRegister() {
            const vals = ['email','name','receiver','phone','store'].reduce((a,k)=>{a[k]=document.getElementById('reg-'+k).value;return a},{});
            showLoading();
            try { await callApi('register', {...vals, uid:currentUid}); location.reload(); }
            catch(e) { hideLoading(); alert(e.message); }
        }

        async function loadMarkets(uid) {
            const div = document.getElementById('market-list');
            div.innerHTML = '<div class="text-center small text-muted">載入中...</div>';
            const mkts = await callApi('getMarkets', {uid});
            div.innerHTML = mkts.length ? mkts.map(m => `
                <div class="dashboard-card border-start border-4 border-primary p-3">
                    <h6 class="fw-bold">${m.sheetName}</h6>
                    <p class="small text-muted mb-2">${m.desc||''}</p>
                    <a href="${m.link}" target="_blank" class="btn btn-outline-primary btn-sm w-100 rounded-pill">前往下單</a>
                </div>`).join('') : '<div class="text-center small text-muted">無可用賣場</div>';
        }

        async function loadOrders(uid) {
            const divDetails = document.getElementById('order-details-list');
            const divSummary = document.getElementById('order-summary-list');
            
            divDetails.innerHTML = '<div class="text-center small text-muted py-2">載入明細...</div>';
            divSummary.innerHTML = '<div class="text-center small text-muted py-2">載入對帳...</div>';
            
            try {
                // 這次回傳的是 { details: [], summary: [] }
                const data = await callApi('getOrders', {uid});
                
                // 1. 渲染明細 (Source A)
                if (data.details && data.details.length > 0) {
                    divDetails.innerHTML = data.details.map(d => `
                        <div class="detail-item fade-in">
                            <div>
                                <span class="fw-bold text-dark">${d.item}</span>
                                <span class="batch-tag">${d.note}</span>
                            </div>
                            <span class="badge bg-secondary rounded-pill">x${d.qty}</span>
                        </div>
                    `).join('');
                } else {
                    divDetails.innerHTML = '<div class="text-center small text-muted py-3">尚無訂購紀錄</div>';
                }

                // 2. 渲染對帳 (Source B)
                if (data.summary && data.summary.length > 0) {
                    divSummary.innerHTML = data.summary.map(s => {
                        let colorClass = 'status-wait'; // 預設黃色
                        if (s.status.includes('✅') || s.status.includes('核對')) colorClass = 'status-ok'; // 綠色
                        else if (s.status.includes('❌')) colorClass = 'status-err'; // 紅色
                        else if (s.status.includes('貨到')) colorClass = 'status-cod'; // 藍色

                        return `
                        <div class="status-card ${colorClass} fade-in">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold fs-5 text-dark">$${s.total}</span>
                                <span class="badge bg-light text-dark border">${s.status}</span>
                            </div>
                            <div class="small text-muted mt-1">應付總額</div>
                        </div>`;
                    }).join('');
                } else {
                    divSummary.innerHTML = '<div class="text-center small text-muted py-3">尚無對帳資料</div>';
                }

            } catch (e) {
                console.error(e);
                divDetails.innerHTML = '<div class="text-danger small text-center">載入失敗</div>';
                divSummary.innerHTML = '';
            }
        }

        function switchTab(tab, btn) {
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
            document.getElementById('tab-' + tab).classList.remove('hidden');
            
            if (tab === 'orders') loadOrders(currentUid);
        }

        function showView(id) {
            ['register-view', 'dashboard-view'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
        function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
    </script>
</body>
</html>
