<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ormkubï½œè¨‚å–®æŸ¥è©¢</title>
  <style>
    :root{
      --bg:#0b0c10;
      --card:#11131a;
      --card2:#0f1117;
      --text:#f4f5f7;
      --muted:rgba(244,245,247,.68);
      --line:rgba(244,245,247,.10);
      --line2:rgba(244,245,247,.14);
      --accent:#9ae6ff;
      --ok:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Heiti TC", "Microsoft JhengHei", Arial;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 650px at 18% -10%, rgba(154,230,255,.14), transparent 55%),
        radial-gradient(1000px 600px at 92% 0%, rgba(251,113,133,.10), transparent 55%),
        radial-gradient(900px 520px at 50% 120%, rgba(52,211,153,.08), transparent 55%),
        var(--bg);
    }
    a{ color:inherit; }

    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 26px 16px 80px;
    }

    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      margin-bottom: 16px;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .brand .logo{
      font-weight: 900;
      letter-spacing:.2px;
      font-size: 22px;
      line-height: 1.1;
    }
    .brand .sub{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
      max-width: 740px;
    }

    .chip{
      font-family:var(--mono);
      font-size: 12px;
      color: rgba(244,245,247,.78);
      border:1px solid var(--line2);
      background: rgba(244,245,247,.05);
      padding: 8px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    .chip.ok{ border-color: rgba(52,211,153,.35); background: rgba(52,211,153,.10); color: var(--ok); }
    .chip.warn{ border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.10); color: var(--warn); }
    .chip.bad{ border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.10); color: var(--bad); }

    .panel{
      background: linear-gradient(180deg, rgba(244,245,247,.06), rgba(244,245,247,.03));
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding: 14px;
      backdrop-filter: blur(8px);
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .input{
      flex:1;
      min-width: 240px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--line2);
      outline: none;
      background: rgba(0,0,0,.25);
      color: var(--text);
      font-size: 15px;
    }
    .input::placeholder{ color: rgba(244,245,247,.40); }
    #emailInput{ display:none; }

    .btn{
      padding: 12px 16px;
      border: 0;
      border-radius: 14px;
      cursor: pointer;
      background: rgba(244,245,247,.92);
      color: #0b0c10;
      font-weight: 900;
      letter-spacing:.2px;
      min-width: 120px;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
    }

    .hint{
      margin-top:10px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }

    .status{
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
      white-space: pre-line;
    }

    .fileBlock{
      margin-top: 14px;
      border-radius: var(--radius);
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    .fileHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      background: rgba(244,245,247,.03);
    }
    .fileName{
      font-weight: 900;
      letter-spacing:.2px;
    }
    .fileMeta{
      color: var(--muted);
      font-size: 12px;
      font-family: var(--mono);
    }

    .orders{
      padding: 12px 14px 16px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .orderCard{
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(17,19,26,.75);
      overflow:hidden;
    }

    .orderTop{
      padding: 12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      border-bottom: 1px solid var(--line);
      background: rgba(244,245,247,.03);
    }

    .orderId{
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(244,245,247,.80);
      margin:0 0 4px;
    }

    .buyer{
      font-size: 16px;
      font-weight: 900;
      margin:0;
      letter-spacing:.2px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      border: 1px solid var(--line2);
      background: rgba(244,245,247,.05);
      white-space: nowrap;
    }
    .badge.ok{ border-color: rgba(52,211,153,.35); color: var(--ok); background: rgba(52,211,153,.10); }
    .badge.warn{ border-color: rgba(251,191,36,.35); color: var(--warn); background: rgba(251,191,36,.10); }
    .badge.bad{ border-color: rgba(251,113,133,.35); color: var(--bad); background: rgba(251,113,133,.10); }

    .orderBody{
      padding: 12px 14px 14px;
    }

    .sectionTitle{
      margin: 14px 0 8px;
      font-size: 13px;
      color: rgba(244,245,247,.88);
      font-weight: 900;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .kv{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap: 8px 12px;
      padding: 10px 0;
      border-bottom: 1px dashed rgba(244,245,247,.12);
      font-size: 13px;
    }
    .kv:last-child{ border-bottom:0; padding-bottom:0; }
    .k{ color: var(--muted); }
    .v{ color: rgba(244,245,247,.92); }
    .v.mono{ font-family: var(--mono); font-size: 12.5px; }

    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid var(--line);
    }
    .table th, .table td{
      padding: 10px 10px;
      border-bottom: 1px solid var(--line);
      vertical-align: top;
      font-size: 13px;
    }
    .table th{
      text-align:left;
      color: rgba(244,245,247,.80);
      background: rgba(244,245,247,.04);
      font-weight: 900;
      font-size: 12px;
      letter-spacing: .2px;
    }
    .table tr:last-child td{ border-bottom:0; }

    .empty{
      padding: 10px 12px;
      border: 1px dashed rgba(244,245,247,.18);
      border-radius: 14px;
      color: var(--muted);
      font-size: 13px;
    }

    .footerNote{
      margin-top: 16px;
      color: rgba(244,245,247,.55);
      font-size: 12px;
      line-height: 1.45;
    }

    /* Loading overlay */
    .overlay{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      z-index: 9999;
    }
    .overlay.show{ display:flex; }
    .overlayCard{
      width: min(520px, 100%);
      border-radius: 18px;
      border: 1px solid var(--line2);
      background: rgba(17,19,26,.92);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .spinner{
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: 2px solid rgba(244,245,247,.25);
      border-top-color: rgba(244,245,247,.85);
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }
    .overlayRow{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .overlayTitle{
      font-weight: 900;
      letter-spacing:.2px;
    }
    .overlayMsg{
      margin-top: 6px;
      color: var(--muted);
      font-size: 13px;
      white-space: pre-line;
    }

    @media (max-width: 540px){
      .kv{ grid-template-columns: 120px 1fr; }
      .btn{ width:100%; }
      .input{ width:100%; }
      .orderTop{ flex-direction: column; align-items:flex-start; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">Ormkub è¨‚å–®æŸ¥è©¢</div>
        <div class="sub">ç³»çµ±æœƒè‡ªå‹•è®€å–æ‚¨çš„ LINE èº«åˆ†ä¸¦æŸ¥è©¢è¨‚å–®ã€‚è‹¥æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œè«‹ä¾æç¤ºç¶å®šä¸‹å–® Emailï¼ˆåªéœ€ä¸€æ¬¡ï¼‰ã€‚</div>
      </div>
      <div id="chip" class="chip">é€£ç·šä¸­â€¦</div>
    </div>

    <div class="panel">
      <div class="row">
        <input id="emailInput" class="input" type="email" placeholder="è«‹è¼¸å…¥ä¸‹å–®æ™‚çš„ Emailï¼ˆé¦–æ¬¡ç¶å®šç”¨ï¼‰" autocomplete="email" />
        <button id="searchBtn" class="btn">æŸ¥è©¢</button>
      </div>
      <div class="hint">
        â€¢ å·²ç¶å®šè€…ï¼šé–‹å•Ÿé é¢å¾Œæœƒè‡ªå‹•æŸ¥è©¢ä¸¦é¡¯ç¤ºçµæœ<br/>
        â€¢ æœªç¶å®šè€…ï¼šè«‹è¼¸å…¥ã€Œä¸‹å–® Emailã€å®Œæˆç¶å®šå¾Œå³å¯æŸ¥è©¢<br/>
        â€¢ ç¶å®šè³‡æ–™æœƒå¯«å…¥ Usersï¼ˆEmail / LINE_UIDï¼‰åƒ…ç”¨æ–¼æœ¬æŸ¥è©¢åŠŸèƒ½
      </div>
      <div id="status" class="status"></div>
    </div>

    <div id="results"></div>

    <div class="footerNote">
      æ³¨æ„ï¼šè‹¥è³‡æ–™é‡éå¸¸å¤§ï¼ˆè³‡æ–™å¤¾å…§è©¦ç®—è¡¨å¾ˆå¤šã€æ¯å¼µè¡¨å¾ˆå¤šåˆ—ï¼‰ï¼Œé¦–æ¬¡æŸ¥è©¢å¯èƒ½è¼ƒä¹…ã€‚è‹¥é‡åˆ°æŸ¥ä¸åˆ°ï¼Œè«‹å…ˆç¢ºèªã€Œç·¨è™Ÿé…ç½®ã€D æ¬„ Email æ˜¯å¦å®Œå…¨ä¸€è‡´ï¼ˆå¤§å°å¯«ä¸å½±éŸ¿ï¼Œä½†ç©ºç™½æœƒå½±éŸ¿ï¼‰ã€‚
    </div>
  </div>

  <script>
    // âœ… ä½ çš„æ–°éƒ¨ç½² /exec
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyRYlpBD7-Vdnq1cvp_lDin3Tq_7L78X83vQTa7M3kXEX9g-PVhstIJcpO5RdCTtQMN/exec";

    // âœ… è‹¥è¦ç”¨ LINE UID è‡ªå‹•æŸ¥è©¢ï¼šè«‹æŠŠä½ çš„ LIFF ID å¡«åœ¨é€™è£¡ï¼ˆä¸¦ç”¨ LIFF é–‹å•Ÿæ­¤é ï¼‰
    // ä¾‹å¦‚ï¼šconst LIFF_ID = "165xxxxxxx-XXXXXXXX";
    const LIFF_ID = "2008825521-dLeF3YrA";

    const urlParams = new URLSearchParams(location.search);
    const UID_FROM_URL = (urlParams.get("uid") || "").trim();

    let CURRENT_UID = UID_FROM_URL || "";

    const $ = (id) => document.getElementById(id);

    function setChip(text, tone = "") {
      const el = $("chip");
      if (!el) return;
      el.textContent = text || "";
      el.classList.remove("ok", "warn", "bad");
      if (tone) el.classList.add(tone);
    }

    function maskUid(uid) {
      const s = String(uid || "").trim();
      if (!s) return "";
      if (s.length <= 10) return s;
      return s.slice(0, 4) + "â€¦" + s.slice(-4);
    }

    function showOverlay(title, msg) {
      $("overlayTitle").textContent = title || "è™•ç†ä¸­â€¦";
      $("overlayMsg").textContent = msg || "è«‹ç¨å€™";
      $("overlay").classList.add("show");
    }

    function hideOverlay() {
      $("overlay").classList.remove("show");
    }

function setSearchButtonLabel(mode) {
  const btn = $("searchBtn");
  if (!btn) return;
  // mode: "search" | "bind"
  btn.textContent = mode === "bind" ? "ç¶å®šä¸¦æŸ¥è©¢" : "æŸ¥è©¢";
}

    function setStatus(msg) {
      $("status").textContent = msg || "";
    }

    function setEmailInputEnabled(enabled) {
      const input = $("emailInput");
      input.disabled = !enabled;
      input.style.opacity = enabled ? "1" : "0.6";
    }

    function setEmailInputVisible(visible) {
  	const input = $("emailInput");
  	// CSS é è¨­ display:noneï¼Œæ‰€ä»¥è¦é¡¯ç¤ºæ™‚å¿…é ˆå¼·åˆ¶æŒ‡å®š display
  	input.style.display = visible ? "block" : "none";
}

// åˆå§‹ï¼šå…ˆéš±è— Email è¼¸å…¥æ¡†ï¼›åªæœ‰ç¢ºèª UID å°šæœªç¶å®šæ™‚æ‰é¡¯ç¤º
setEmailInputVisible(false);
setEmailInputEnabled(false);
setSearchButtonLabel("search");

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email || "").trim());
    }

    function fmtMoney(v) {
      if (v === "" || v === null || v === undefined) return "";
      const n = Number(v);
      return Number.isFinite(n) ? n.toLocaleString("en-US") : String(v);
    }

    function normalizeText(v) {
      return String(v ?? "").trim();
    }

    function normalizeOrderId(v) {
      return String(v ?? "").trim();
    }

    function statusBadge(payStatus) {
      const s = normalizeText(payStatus);
      const low = s.toLowerCase();
      if (!s) return `<span class="badge warn">ä»˜æ¬¾ç‹€æ…‹ï¼šæœªå¡«</span>`;
      if (low.includes("å·²") || low.includes("å®Œæˆ") || low.includes("paid") || low.includes("ok")) {
        return `<span class="badge ok">ä»˜æ¬¾ç‹€æ…‹ï¼š${escapeHtml(s)}</span>`;
      }
      if (low.includes("æœª") || low.includes("å¾…") || low.includes("æ¬ ") || low.includes("pending")) {
        return `<span class="badge warn">ä»˜æ¬¾ç‹€æ…‹ï¼š${escapeHtml(s)}</span>`;
      }
      return `<span class="badge warn">ä»˜æ¬¾ç‹€æ…‹ï¼š${escapeHtml(s)}</span>`;
    }

    /** JSONP call */
    function jsonpCall(action, params = {}) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Date.now() + "_" + Math.random().toString(16).slice(2);
        params.action = action;
        params.callback = cb;

        const url = WEBAPP_URL + "?" + new URLSearchParams(params).toString();

        const script = document.createElement("script");
        const timer = setTimeout(() => {
          cleanup();
          reject(new Error("JSONP timeout"));
        }, 20000);

        function cleanup() {
          clearTimeout(timer);
          try { delete window[cb]; } catch (_) { window[cb] = undefined; }
          if (script.parentNode) script.parentNode.removeChild(script);
        }

        window[cb] = (data) => { cleanup(); resolve(data); };
        script.onerror = () => { cleanup(); reject(new Error("JSONP load error")); };
        script.src = url;
        document.body.appendChild(script);
      });
    }

    /** Group API result -> by file -> by orderId */
    function buildOrderIndex(apiRes) {
      const fileBlocks = [];

      for (const pack of (apiRes.results || [])) {
        if (pack.error) {
          fileBlocks.push({
            fileName: pack.fileName || "ï¼ˆæœªå‘½åï¼‰",
            fileId: pack.fileId || "",
            error: pack.error,
            orders: []
          });
          continue;
        }

        const orderMap = new Map();
        const orderIds = (pack.orderIds || []).map(normalizeOrderId).filter(Boolean);

        // from mapping buyers array (same index as orderIds)
        const buyers = (pack.buyers || []).map(normalizeText);

        for (let i = 0; i < orderIds.length; i++) {
          const oid = orderIds[i];
          if (!orderMap.has(oid)) {
            orderMap.set(oid, {
              è¨‚å–®ç·¨è™Ÿ: oid,
              è¨‚è³¼äºº: buyers[i] || "",
              å°å¸³: null,
              é…è²¨: []
            });
          } else {
            // if repeated oid, keep buyer if empty
            const o = orderMap.get(oid);
            if (!o.è¨‚è³¼äºº && buyers[i]) o.è¨‚è³¼äºº = buyers[i];
          }
        }

        // attach å°å¸³ rows
        const billRows = (pack["å°å¸³è¡¨"] && pack["å°å¸³è¡¨"].rows) ? pack["å°å¸³è¡¨"].rows : [];
        for (const r of billRows) {
          const oid = normalizeOrderId(r["è¨‚å–®ç·¨è™Ÿ"]);
          if (!oid) continue;
          if (!orderMap.has(oid)) {
            orderMap.set(oid, { è¨‚å–®ç·¨è™Ÿ: oid, è¨‚è³¼äºº: normalizeText(r["è¨‚è³¼äºº"]), å°å¸³: r, é…è²¨: [] });
          } else {
            const o = orderMap.get(oid);
            if (!o.è¨‚è³¼äºº && r["è¨‚è³¼äºº"]) o.è¨‚è³¼äºº = normalizeText(r["è¨‚è³¼äºº"]);
            // if multiple reconcile rows exist, keep the first non-empty, else overwrite
            if (!o.å°å¸³) o.å°å¸³ = r;
          }
        }

        // attach é…è²¨ rows
        const shipRows = (pack["é…è²¨"] && pack["é…è²¨"].rows) ? pack["é…è²¨"].rows : [];
        for (const r of shipRows) {
          const oid = normalizeOrderId(r["è¨‚å–®ç·¨è™Ÿ"]);
          if (!oid) continue;
          if (!orderMap.has(oid)) {
            orderMap.set(oid, { è¨‚å–®ç·¨è™Ÿ: oid, è¨‚è³¼äºº: normalizeText(r["è¨‚è³¼äºº"]), å°å¸³: null, é…è²¨: [r] });
          } else {
            const o = orderMap.get(oid);
            if (!o.è¨‚è³¼äºº && r["è¨‚è³¼äºº"]) o.è¨‚è³¼äºº = normalizeText(r["è¨‚è³¼äºº"]);
            o.é…è²¨.push(r);
          }
        }

        const orders = Array.from(orderMap.values())
          .sort((a,b) => a.è¨‚å–®ç·¨è™Ÿ.localeCompare(b.è¨‚å–®ç·¨è™Ÿ, "zh-Hant"));

        fileBlocks.push({
          fileName: pack.fileName || "ï¼ˆæœªå‘½åï¼‰",
          fileId: pack.fileId || "",
          error: "",
          orders
        });
      }

      return fileBlocks;
    }

    function render(apiRes) {
      const root = $("results");
      root.innerHTML = "";

      if (!apiRes || !apiRes.ok) {
        root.innerHTML = `
          <div class="panel" style="border-color: rgba(251,113,133,.35);">
            <div style="font-weight:900;">âŒ æŸ¥è©¢å¤±æ•—</div>
            <div class="status" style="color: rgba(251,113,133,.95); margin-top:6px;">
              ${escapeHtml(apiRes?.error || "æœªçŸ¥éŒ¯èª¤")}
            </div>
          </div>`;
        return;
      }

      const fileBlocks = buildOrderIndex(apiRes);

      if (!fileBlocks.length || fileBlocks.every(b => !b.orders.length && !b.error)) {
        root.innerHTML = `
          <div class="panel">
            <div style="font-weight:900;">æŸ¥ä¸åˆ°è³‡æ–™</div>
            <div class="status">å·²æƒæ ${apiRes.scannedFiles} ä»½æª”æ¡ˆï¼Œæœªæ‰¾åˆ°ç¬¦åˆçš„è¨‚å–®ç·¨è™Ÿã€‚</div>
          </div>`;
        return;
      }

      for (const block of fileBlocks) {
        const meta = block.fileId ? `ï¼ˆ${escapeHtml(block.fileId.slice(0,8))}â€¦ï¼‰` : "";
        const headHtml = `
          <div class="fileHead">
            <div class="fileName">ğŸ“„ ${escapeHtml(block.fileName)}</div>
            <div class="fileMeta">${block.orders.length} ç­†è¨‚å–® ${meta}</div>
          </div>`;

        let bodyHtml = "";

        if (block.error) {
          bodyHtml = `
            <div class="orders">
              <div class="empty">âš ï¸ ${escapeHtml(block.error)}</div>
            </div>`;
        } else {
          bodyHtml = `<div class="orders">
            ${block.orders.map(renderOrderCard).join("")}
          </div>`;
        }

        root.insertAdjacentHTML("beforeend", `
          <div class="fileBlock">
            ${headHtml}
            ${bodyHtml}
          </div>
        `);
      }
    }

    function renderOrderCard(o) {
      const bill = o.å°å¸³ || null;

      const payStatus = bill ? bill["ä»˜æ¬¾ç‹€æ…‹"] : "";
      const badge = statusBadge(payStatus);

      const buyer = normalizeText(o.è¨‚è³¼äºº) || (bill ? normalizeText(bill["è¨‚è³¼äºº"]) : "") || "ï¼ˆæœªå¡«è¨‚è³¼äººï¼‰";

      const billKv = bill ? `
        <div class="kv">
          <div class="k">è³¼è²·ç¸½ä»¶æ•¸</div><div class="v">${escapeHtml(bill["è³¼è²·ç¸½ä»¶æ•¸"] ?? "")}</div>
          <div class="k">æ‡‰æ”¶é‡‘é¡</div><div class="v mono">${escapeHtml(fmtMoney(bill["æ‡‰æ”¶é‡‘é¡"]))}</div>
          <div class="k">ä»˜æ¬¾ç‹€æ…‹</div><div class="v">${escapeHtml(bill["ä»˜æ¬¾ç‹€æ…‹"] ?? "")}</div>
          <div class="k">ä»˜æ¬¾æ—¥æœŸ</div><div class="v">${escapeHtml(bill["ä»˜æ¬¾æ—¥æœŸ"] ?? "")}</div>
          <div class="k">å¾Œäº”ç¢¼</div><div class="v mono">${escapeHtml(bill["å¾Œäº”ç¢¼"] ?? "")}</div>
          <div class="k">æ”¶æ¬¾é‡‘é¡</div><div class="v mono">${escapeHtml(fmtMoney(bill["æ”¶æ¬¾é‡‘é¡"]))}</div>
          <div class="k">å‚™è¨»</div><div class="v">${escapeHtml(bill["å‚™è¨»"] ?? "")}</div>
        </div>
      ` : `<div class="empty">æ²’æœ‰æ‰¾åˆ°æ­¤è¨‚å–®çš„ã€Œå°å¸³è¡¨ã€è³‡æ–™ã€‚</div>`;

      const shipRows = Array.isArray(o.é…è²¨) ? o.é…è²¨ : [];
      const shipTable = shipRows.length ? `
        <table class="table">
          <thead>
            <tr>
              <th style="width:46%;">è¨‚è³¼å•†å“</th>
              <th style="width:12%;">ç™»è¨˜</th>
              <th style="width:12%;">é…è²¨</th>
              <th style="width:30%;">é…è²¨çµæœ</th>
            </tr>
          </thead>
          <tbody>
            ${shipRows.map(r => `
              <tr>
                <td>${escapeHtml(r["è¨‚è³¼å•†å“"] ?? "")}</td>
                <td class="mono">${escapeHtml(r["ç™»è¨˜æ•¸é‡"] ?? "")}</td>
                <td class="mono">${escapeHtml(r["é…è²¨æ•¸é‡"] ?? "")}</td>
                <td>${escapeHtml(r["é…è²¨çµæœ"] ?? "")}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      ` : `<div class="empty">æ²’æœ‰æ‰¾åˆ°æ­¤è¨‚å–®çš„ã€Œé…è²¨ã€è³‡æ–™ã€‚</div>`;

      return `
        <div class="orderCard">
          <div class="orderTop">
            <div>
              <p class="orderId">è¨‚å–®ç·¨è™Ÿï¼š${escapeHtml(o.è¨‚å–®ç·¨è™Ÿ)}</p>
              <p class="buyer">${escapeHtml(buyer)}</p>
            </div>
            <div>${badge}</div>
          </div>

          <div class="orderBody">
            <div class="sectionTitle">ğŸ§¾ å°å¸³è³‡æ–™</div>
            ${billKv}

            <div class="sectionTitle">ğŸ“¦ é…è²¨æ˜ç´°</div>
            ${shipTable}
          </div>
        </div>
      `;
    }

    async function doSearch() {
      const email = String($("emailInput").value || "").trim();

      $("searchBtn").disabled = true;
      setStatus("æŸ¥è©¢ä¸­â€¦ï¼ˆæ­£åœ¨æƒæè³‡æ–™å¤¾å…§è©¦ç®—è¡¨ï¼‰");
      showOverlay("æŸ¥è©¢ä¸­â€¦", "æ­£åœ¨ç‚ºæ‚¨æœå°‹è¨‚å–®è³‡æ–™");
      setChip("æŸ¥è©¢ä¸­â€¦", "warn");

      try {
        let res = null;

        // 1) æœ‰ LINE UID â†’ å„ªå…ˆç”¨ UID è‡ªå‹•æŸ¥ï¼ˆä¸ç”¨ emailï¼‰
        if (CURRENT_UID) {
          setEmailInputEnabled(false);
          res = await jsonpCall("searchByUid", { uid: CURRENT_UID });

          if (res && res.ok) {
            setStatus(`æŸ¥è©¢å®Œæˆï¼šæƒæ ${res.scannedFiles} ä»½æª”æ¡ˆï¼Œæ‰¾åˆ° ${res.matchedFiles} ä»½æœ‰è³‡æ–™ã€‚`);
            render(res);
            setChip("å·²ç¶å®š Â· å·²é¡¯ç¤ºè¨‚å–®", "ok");
            // å·²ç¶å®šæˆåŠŸå¾Œï¼Œemail å¯éš±è—ï¼ˆæƒ³ä¿ç•™ä¹Ÿå¯ä»¥æ”¹æˆ trueï¼‰
            setEmailInputVisible(false);
            setSearchButtonLabel("search");
            hideOverlay();
            return;
          }

          // UID æœ‰ï¼Œä½†å°šæœªç¶å®š email
          // è‹¥ä½¿ç”¨è€…å·²è¼¸å…¥ Emailï¼ˆæ ¼å¼æ­£ç¢ºï¼‰â†’ ç›´æ¥ç¶å®šä¸¦å†æŸ¥ä¸€æ¬¡
          if (isValidEmail(email)) {
            setEmailInputVisible(true);
            setEmailInputEnabled(false);
            setStatus("ç¶å®šä¸­â€¦");
            setChip("ç¶å®šä¸­â€¦", "warn");

            await jsonpCall("saveEmail", { email, uid: CURRENT_UID });
            const res2 = await jsonpCall("searchByUid", { uid: CURRENT_UID });

            if (res2 && res2.ok) {
              setStatus(`æŸ¥è©¢å®Œæˆï¼šæƒæ ${res2.scannedFiles} ä»½æª”æ¡ˆï¼Œæ‰¾åˆ° ${res2.matchedFiles} ä»½æœ‰è³‡æ–™ã€‚`);
              render(res2);
              setChip("å·²ç¶å®š Â· å·²é¡¯ç¤ºè¨‚å–®", "ok");
              setEmailInputVisible(false);
setSearchButtonLabel("search");
              hideOverlay();
              return;
            }

            // ç¶å®šå¾Œä»æŸ¥ä¸åˆ°ï¼ˆå¯èƒ½ email ä¸åœ¨ä»»ä½•è¨‚å–®ï¼‰
            setEmailInputVisible(true);
            setEmailInputEnabled(true);
            setStatus(res2?.error || "ç¶å®šå®Œæˆä½†æŸ¥ä¸åˆ°è¨‚å–®è³‡æ–™ï¼Œè«‹ç¢ºèª Email æ˜¯å¦ç‚ºä¸‹å–®æ™‚å¡«å¯«çš„ Emailã€‚");
            setChip("å·²ç¶å®š Â· æŸ¥ç„¡è¨‚å–®", "warn");
            $("emailInput").focus();
            hideOverlay();
            return;
          }

          // å°šæœªè¼¸å…¥ Email æˆ–æ ¼å¼ä¸æ­£ç¢º â†’ é¡¯ç¤ºè¼¸å…¥æ¡†æç¤ºç¶å®š
          setEmailInputVisible(true);
setEmailInputEnabled(true);
setSearchButtonLabel("bind");
setStatus(res?.error || "æ­¤å¸³è™Ÿå°šæœªç¶å®š Emailï¼Œè«‹è¼¸å…¥ Email é€²è¡Œç¶å®šå¾Œå†æŸ¥è©¢ã€‚");
setChip("å°šæœªç¶å®š Email", "warn");
$("emailInput").focus();
hideOverlay();
return;
        }

        // 2) æ²’æœ‰ UID â†’ èµ°æ‰‹å‹• email æŸ¥
        setEmailInputVisible(true);
        setEmailInputEnabled(true);
        setSearchButtonLabel("search");
        if (!isValidEmail(email)) {
          setStatus("è«‹è¼¸å…¥æ­£ç¢ºçš„ Email æ ¼å¼ã€‚");
          $("emailInput").focus();
          hideOverlay();
          return;
        }

        res = await jsonpCall("search", { email });
        setStatus(res && res.ok
          ? `æŸ¥è©¢å®Œæˆï¼šæƒæ ${res.scannedFiles} ä»½æª”æ¡ˆï¼Œæ‰¾åˆ° ${res.matchedFiles} ä»½æœ‰è³‡æ–™ã€‚`
          : `æŸ¥è©¢å¤±æ•—ï¼š${res?.error || "æœªçŸ¥éŒ¯èª¤"}`
        );
        render(res);
        if (res && res.ok) {
          setChip("å·²é¡¯ç¤ºè¨‚å–®", "ok");
        }

      } catch (err) {
        setStatus("æŸ¥è©¢å¤±æ•—ï¼ˆé€£ç·šæˆ–éƒ¨ç½²æ¬Šé™å•é¡Œï¼‰ï¼š" + (err?.message || err));
        render({ ok:false, error: String(err?.message || err) });
        setChip("æŸ¥è©¢å¤±æ•—", "bad");
      } finally {
        $("searchBtn").disabled = false;
        hideOverlay();
      }
    }


    async function initPage() {
      setChip("é€£ç·šä¸­â€¦");
      hideOverlay();
      // events
      $("searchBtn").addEventListener("click", doSearch);
      $("emailInput").addEventListener("keydown", (e) => {
        if (e.key === "Enter") doSearch();
      });

      try {
        const ping = await jsonpCall("ping", {});
        if (ping && ping.ok) setStatus("API å·²é€£ç·š âœ…");
        if (ping && ping.ok) setChip("API å·²é€£ç·š", "ok");

        // è‹¥æœ‰ LIFF_IDï¼Œå°±å‹•æ…‹è¼‰å…¥ LIFF SDK ä¸¦å˜—è©¦å–å¾— userId
        if (LIFF_ID) {
          await new Promise((resolve, reject) => {
            const s = document.createElement("script");
            s.src = "https://static.line-scdn.net/liff/edge/2/sdk.js";
            s.onload = resolve;
            s.onerror = reject;
            document.head.appendChild(s);
          });

          await liff.init({ liffId: LIFF_ID });
          if (!liff.isLoggedIn()) {
            setStatus("æ­£åœ¨å°å‘ LINE ç™»å…¥â€¦");
            showOverlay("éœ€è¦ç™»å…¥ LINE", "å³å°‡é–‹å•Ÿç™»å…¥ç•«é¢ï¼Œç™»å…¥å¾Œæœƒè‡ªå‹•æŸ¥è©¢ã€‚\nè‹¥æœªè‡ªå‹•è¿”å›ï¼Œè«‹å›åˆ°æ­¤é é‡æ–°é–‹å•Ÿã€‚\n");
            setChip("éœ€è¦ç™»å…¥ LINE", "warn");
            liff.login();
            return;
          }
          const profile = await liff.getProfile();
          CURRENT_UID = (profile.userId || "").trim();
          setChip("å·²ç™»å…¥ LINE Â· " + maskUid(CURRENT_UID), "ok");
        }

        // æœ‰ UIDï¼ˆLIFF æˆ– URL åƒæ•¸ï¼‰å°±è‡ªå‹•æŸ¥
        if (CURRENT_UID) {
          setEmailInputEnabled(false);
          showOverlay("è‡ªå‹•æŸ¥è©¢ä¸­â€¦", "æ­£åœ¨ç‚ºæ‚¨æœå°‹è¨‚å–®è³‡æ–™");
          setChip("è‡ªå‹•æŸ¥è©¢ä¸­â€¦", "warn");
          const res = await jsonpCall("searchByUid", { uid: CURRENT_UID });
          if (res && res.ok) {
            setStatus(`è‡ªå‹•æŸ¥è©¢å®Œæˆï¼šæƒæ ${res.scannedFiles} ä»½æª”æ¡ˆï¼Œæ‰¾åˆ° ${res.matchedFiles} ä»½æœ‰è³‡æ–™ã€‚`);
            render(res);
            setEmailInputVisible(false);
 setSearchButtonLabel("search");
            setChip("å·²ç¶å®š Â· å·²é¡¯ç¤ºè¨‚å–®", "ok");
          } else {
            // å°šæœªç¶å®š â†’ é¡¯ç¤º email è¼¸å…¥
setEmailInputVisible(true);
setEmailInputEnabled(true);
setSearchButtonLabel("bind");
setStatus(res?.error || "æ­¤å¸³è™Ÿå°šæœªç¶å®š Emailï¼Œè«‹è¼¸å…¥ Email é€²è¡Œç¶å®šã€‚\nï¼ˆç¶å®šå¾Œä¸‹æ¬¡å°±ä¸ç”¨å†è¼¸å…¥ï¼‰");
setChip("å°šæœªç¶å®š Email", "warn");
          }
          hideOverlay();
        } else {
          setEmailInputVisible(true);
          setEmailInputEnabled(true);
          setStatus("è«‹è¼¸å…¥ Email æŸ¥è©¢ï¼ˆæˆ–ç”¨ LIFF é–‹å•Ÿä»¥ä½¿ç”¨ UID è‡ªå‹•æŸ¥è©¢ï¼‰");
          setChip("è«‹è¼¸å…¥ Email", "warn");
        }

      } catch {
        setStatus("API é€£ç·šæ¸¬è©¦å¤±æ•— âš ï¸ è«‹ç¢ºèª Web App éƒ¨ç½²æ¬Šé™ç‚ºã€ä»»ä½•äººã€");
        setEmailInputVisible(true);
        setEmailInputEnabled(true);
        setChip("é€£ç·šå¤±æ•—", "bad");
      }
    }

    // ç­‰æ•´é  DOMï¼ˆåŒ…å« overlayï¼‰éƒ½è¼‰å…¥å¾Œå†åˆå§‹åŒ–ï¼Œé¿å…æ‰¾ä¸åˆ° overlay å…ƒç´ 
    window.addEventListener("DOMContentLoaded", initPage);
  </script>

  <div id="overlay" class="overlay" aria-live="polite" aria-busy="true">
    <div class="overlayCard">
      <div class="overlayRow">
        <div class="spinner" aria-hidden="true"></div>
        <div class="overlayTitle" id="overlayTitle">è™•ç†ä¸­â€¦</div>
      </div>
      <div class="overlayMsg" id="overlayMsg">è«‹ç¨å€™</div>
    </div>
  </div>
</body>
</html>
