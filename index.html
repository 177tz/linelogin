<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>è¨‚å–®æŸ¥è©¢ç³»çµ± - é™¤éŒ¯æ¨¡å¼</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { background-color: #f8f9fa; padding: 10px; padding-bottom: 250px; /* é ç•™åº•éƒ¨ç©ºé–“çµ¦ Log */ }
    .card { margin-bottom: 15px; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .hidden { display: none !important; }
    
    /* é™¤éŒ¯è¦–çª—æ¨£å¼ */
    #debug-console {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 220px;
      background-color: #212529;
      color: #00ff00;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      padding: 10px;
      overflow-y: auto;
      z-index: 10000;
      border-top: 3px solid #ffc107;
    }
    .log-line { margin-bottom: 2px; border-bottom: 1px solid #333; }
    .log-err { color: #ff4444; font-weight: bold; }
    .log-warn { color: #ffbb33; }
  </style>
</head>
<body>

  <div id="loading" class="text-center py-4">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2" id="loading-text">ç³»çµ±å•Ÿå‹•ä¸­...</p>
  </div>

  <div class="container" style="max-width: 600px;">
    <h4 class="text-center mb-4">ğŸ“¦ è¨‚å–®æŸ¥è©¢ (é™¤éŒ¯ç‰ˆ)</h4>

    <div id="login-section" class="card p-4 hidden">
      <div class="mb-3">
        <label class="form-label">è«‹è¼¸å…¥ Email æŸ¥è©¢</label>
        <input type="email" class="form-control" id="emailInput" placeholder="name@example.com">
      </div>
      <button onclick="performSearch()" class="btn btn-primary w-100">æŸ¥è©¢è¨‚å–®</button>
    </div>

    <div id="welcome-section" class="alert alert-success hidden">
      å·²è­˜åˆ¥ç”¨æˆ¶ï¼š<strong id="user-email-display"></strong>
    </div>

    <div id="result-section" class="hidden">
      <h5>æŸ¥è©¢çµæœï¼š</h5>
      <div id="orders-container"></div>
      <button onclick="resetSearch()" class="btn btn-outline-secondary w-100 mt-3">é‡æ–°æŸ¥è©¢</button>
    </div>
  </div>

  <div id="debug-console">
    <div class="d-flex justify-content-between sticky-top bg-dark border-bottom pb-1 mb-1">
      <strong>ğŸ“ ç³»çµ±ç´€éŒ„ (Debug Log)</strong>
      <button class="btn btn-sm btn-light py-0" onclick="document.getElementById('debug-content').innerHTML=''">æ¸…ç©º</button>
    </div>
    <div id="debug-content">
      </div>
  </div>

  <script>
    // â˜…â˜…â˜… è¨­å®šå€ â˜…â˜…â˜…
    const MY_LIFF_ID = "ä½ çš„LIFF_ID_å¡«åœ¨é€™è£¡"; 
    // å¦‚æœä½ åœ¨é›»è…¦æ¸¬è©¦ï¼Œè«‹ä¿æŒä¸Šé¢ç‚º "" æˆ–å¡«å…¥æ­£ç¢º ID
    
    let userUid = "";

    // === ç´€éŒ„å·¥å…·å‡½å¼ ===
    function log(msg, type = 'info') {
      const el = document.getElementById('debug-content');
      const time = new Date().toLocaleTimeString();
      let colorClass = '';
      if(type === 'error') colorClass = 'log-err';
      if(type === 'warn') colorClass = 'log-warn';
      
      const line = `<div class="log-line ${colorClass}">[${time}] ${msg}</div>`;
      el.innerHTML += line;
      // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
      document.getElementById('debug-console').scrollTop = document.getElementById('debug-console').scrollHeight;
      console.log(msg); // åŒæ­¥å°åœ¨ç€è¦½å™¨ Console
    }

    window.onerror = function(message, source, lineno, colno, error) {
      log(`å…¨åŸŸéŒ¯èª¤æ•ç²: ${message}`, 'error');
    };

    // 1. åˆå§‹åŒ–
    window.onload = function() {
      log("ç¶²é è¼‰å…¥å®Œæˆ (window.onload)");
      initializeLiff();
    };

    function initializeLiff() {
      log("æº–å‚™åˆå§‹åŒ– LIFF...");
      
      if (!MY_LIFF_ID) {
        log("âš ï¸ æœªè¨­å®š LIFF IDï¼Œåˆ‡æ›è‡³é›»è…¦æ¸¬è©¦æ¨¡å¼ (ç•¥é LIFF)", 'warn');
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('login-section').classList.remove('hidden');
        return;
      }

      liff.init({ liffId: MY_LIFF_ID })
        .then(() => {
          log("LIFF åˆå§‹åŒ–æˆåŠŸ");
          if (!liff.isLoggedIn()) {
            log("ç”¨æˆ¶æœªç™»å…¥ï¼Œè·³è½‰è‡³ LINE ç™»å…¥é ...");
            liff.login();
          } else {
            log("ç”¨æˆ¶å·²ç™»å…¥ LINE");
            getLiffProfile();
          }
        })
        .catch((err) => {
          log("âŒ LIFF åˆå§‹åŒ–å¤±æ•—: " + err, 'error');
          log("é¡¯ç¤ºæ‰‹å‹•è¼¸å…¥æ¡†ä»¥é¿å…å¡æ­»", 'warn');
          document.getElementById('loading').classList.add('hidden');
          document.getElementById('login-section').classList.remove('hidden');
        });
    }

    function getLiffProfile() {
      log("æ­£åœ¨å–å¾—ä½¿ç”¨è€…è³‡æ–™ (Profile)...");
      liff.getProfile()
        .then(profile => {
          userUid = profile.userId;
          log("âœ… æˆåŠŸå–å¾— UID: " + userUid);
          checkBindingStatus(userUid);
        })
        .catch(err => {
          log("âŒ å–å¾— Profile å¤±æ•—: " + err, 'error');
          alert("ç„¡æ³•å–å¾— LINE ä½¿ç”¨è€…è³‡è¨Š");
        });
    }

    // 2. æª¢æŸ¥ç¶å®š (é€£ç·šå¾Œç«¯)
    function checkBindingStatus(uid) {
      log("æº–å‚™é€£ç·š Google Sheet æª¢æŸ¥ç¶å®šç‹€æ…‹...");
      log("å‘¼å«å¾Œç«¯å‡½å¼: checkUidLink");
      
      if (typeof google === 'undefined') {
        log("âŒ éŒ¯èª¤: google ç‰©ä»¶ä¸å­˜åœ¨ (è«‹ç¢ºèªæ˜¯å¦åœ¨ GAS éƒ¨ç½²ç’°å¢ƒ)", 'error');
        return;
      }

      google.script.run
        .withSuccessHandler(function(boundEmail) {
          log("ğŸ“¡ å¾Œç«¯å›æ‡‰æˆåŠŸï¼");
          if (boundEmail) {
            log("âœ… æ­¤ UID å·²ç¶å®š Email: " + boundEmail);
            document.getElementById('welcome-section').classList.remove('hidden');
            document.getElementById('user-email-display').innerText = boundEmail;
            
            // è‡ªå‹•æŸ¥è©¢
            callBackendSearch(boundEmail, uid);
          } else {
            log("â„¹ï¸ æ­¤ UID å°šæœªç¶å®š Email");
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('login-section').classList.remove('hidden');
          }
        })
        .withFailureHandler(function(err) {
          log("âŒ å¾Œç«¯é€£ç·šå¤±æ•— (checkUidLink): " + err, 'error');
          log("å¯èƒ½æ˜¯æ¬Šé™å•é¡Œï¼Œè«‹æª¢æŸ¥éƒ¨ç½²è¨­å®š (èª°å¯ä»¥å­˜å–: ä»»ä½•äºº)", 'warn');
          document.getElementById('loading').classList.add('hidden');
          document.getElementById('login-section').classList.remove('hidden');
        })
        .checkUidLink(uid);
    }

    // 3. åŸ·è¡ŒæŸ¥è©¢
    function performSearch() {
      var email = document.getElementById('emailInput').value.trim();
      if (!email) {
        log("è«‹è¼¸å…¥ Email", 'warn');
        return;
      }
      
      log("ä½¿ç”¨è€…é»æ“ŠæŸ¥è©¢ï¼ŒEmail: " + email);
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('loading').classList.remove('hidden');
      
      callBackendSearch(email, userUid);
    }

    // 4. å‘¼å«å¾Œç«¯æœå°‹
    function callBackendSearch(email, uid) {
      log(`æº–å‚™æŸ¥è©¢è¨‚å–®... Email: ${email}, UID: ${uid}`);
      log("å‘¼å«å¾Œç«¯å‡½å¼: searchOrdersWithLink");

      google.script.run
        .withSuccessHandler(showResults)
        .withFailureHandler(function(e){
          log("âŒ æŸ¥è©¢å¤±æ•— (searchOrdersWithLink): " + e, 'error');
          document.getElementById('loading').classList.add('hidden');
          document.getElementById('login-section').classList.remove('hidden');
        })
        .searchOrdersWithLink(email, uid);
    }

    // 5. é¡¯ç¤ºçµæœ
    function showResults(data) {
      log("ğŸ“¡ æ”¶åˆ°æŸ¥è©¢çµæœè³‡æ–™");
      log("è³‡æ–™é•·åº¦: " + (data ? data.length : 0));
      
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('welcome-section').classList.add('hidden');
      document.getElementById('result-section').classList.remove('hidden');
      
      const container = document.getElementById('orders-container');
      container.innerHTML = "";

      if (!data || data.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">æŸ¥ç„¡è³‡æ–™ (æˆ–å¾Œç«¯å›å‚³ç‚ºç©º)</div>';
        log("é¡¯ç¤ºæŸ¥ç„¡è³‡æ–™è¨Šæ¯");
        return;
      }

      data.forEach(function(row, index) {
        // é€™è£¡åªæ˜¯ç¯„ä¾‹ï¼Œè«‹ä¾ç…§ä½ çš„è³‡æ–™çµæ§‹èª¿æ•´
        var cardHtml = `
          <div class="card p-3">
             <strong>è¨‚å–® #${index + 1}</strong>
             <p class="m-0">${row.join(', ')}</p>
          </div>
        `;
        container.innerHTML += cardHtml;
      });
      log("âœ… ç•«é¢æ¸²æŸ“å®Œæˆ");
    }

    function resetSearch() {
      log("ä½¿ç”¨è€…é‡ç½®æŸ¥è©¢");
      document.getElementById('result-section').classList.add('hidden');
      document.getElementById('login-section').classList.remove('hidden');
      document.getElementById('emailInput').value = "";
    }

  </script>
</body>
</html>
