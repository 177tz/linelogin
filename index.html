<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>è¨‚å–®æŸ¥è©¢ç³»çµ±</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { background-color: #f8f9fa; padding: 20px; }
    .card { margin-bottom: 15px; border: none; shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .loading-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.9); z-index: 9999;
      display: flex; justify-content: center; align-items: center; flex-direction: column;
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="loading" class="loading-overlay">
    <div class="spinner-border text-primary" role="status"></div>
    <p class="mt-2" id="loading-text">ç³»çµ±åˆå§‹åŒ–ä¸­...</p>
  </div>

  <div class="container" style="max-width: 600px;">
    <h3 class="text-center mb-4">ğŸ“¦ è¨‚å–®æŸ¥è©¢</h3>

    <div id="login-section" class="card p-4 hidden">
      <div class="mb-3">
        <label for="emailInput" class="form-label">è«‹è¼¸å…¥æ‚¨çš„ Email æŸ¥è©¢</label>
        <input type="email" class="form-control" id="emailInput" placeholder="name@example.com">
        <div class="form-text text-muted">ç¬¬ä¸€æ¬¡æŸ¥è©¢å¾Œå°‡è‡ªå‹•ç¶å®šæ‚¨çš„ LINE å¸³è™Ÿã€‚</div>
      </div>
      <button onclick="performSearch()" class="btn btn-primary w-100">æŸ¥è©¢è¨‚å–®</button>
    </div>

    <div id="welcome-section" class="alert alert-success hidden">
      æ­¡è¿å›ä¾†ï¼æ­£åœ¨ç‚ºæ‚¨è¼‰å…¥ <strong id="user-email-display"></strong> çš„è¨‚å–®...
    </div>

    <div id="result-section" class="hidden">
      <h5 class="mb-3">æŸ¥è©¢çµæœ</h5>
      <div id="orders-container">
        </div>
      <button onclick="resetSearch()" class="btn btn-outline-secondary w-100 mt-3">æŸ¥è©¢å…¶ä»– Email</button>
    </div>
    
    <div id="error-msg" class="alert alert-danger hidden mt-3"></div>
  </div>

  <script>
    // â˜…â˜…â˜… è«‹åœ¨æ­¤å¡«å…¥ä½ çš„ LIFF ID â˜…â˜…â˜…
    const MY_LIFF_ID = "ä½ çš„LIFF_ID_å¡«åœ¨é€™è£¡"; 
    
    let userUid = ""; // å„²å­˜å…¨åŸŸ UID

    // 1. é é¢è¼‰å…¥å¾Œåˆå§‹åŒ– LIFF
    window.onload = function() {
      initializeLiff();
    };

    function initializeLiff() {
      // å¦‚æœæ²’æœ‰å¡« LIFF IDï¼Œç›´æ¥é¡¯ç¤ºè¼¸å…¥æ¡† (æ–¹ä¾¿åœ¨ç€è¦½å™¨æ¸¬è©¦)
      if (MY_LIFF_ID === "ä½ çš„LIFF_ID_å¡«åœ¨é€™è£¡" || !MY_LIFF_ID) {
        console.warn("æœªè¨­å®š LIFF IDï¼Œé€²å…¥ç€è¦½å™¨æ¸¬è©¦æ¨¡å¼");
        hideLoading();
        document.getElementById('login-section').classList.remove('hidden');
        return;
      }

      liff.init({ liffId: MY_LIFF_ID })
        .then(() => {
          if (!liff.isLoggedIn()) {
            liff.login();
          } else {
            // å–å¾—ä½¿ç”¨è€…è³‡æ–™
            liff.getProfile()
              .then(profile => {
                userUid = profile.userId;
                console.log("å–å¾— UID: " + userUid);
                checkBindingStatus(userUid);
              })
              .catch(err => {
                console.error('LIFF Profile Error:', err);
                showError("ç„¡æ³•å–å¾—ä½¿ç”¨è€…è³‡è¨Š");
              });
          }
        })
        .catch((err) => {
          console.error('LIFF Init Error:', err);
          // åˆå§‹åŒ–å¤±æ•—ä¹Ÿé¡¯ç¤ºè¼¸å…¥æ¡†ï¼Œé¿å…å¡æ­»
          hideLoading();
          document.getElementById('login-section').classList.remove('hidden');
        });
    }

    // 2. æª¢æŸ¥æ­¤ UID æ˜¯å¦å·²ç¶å®š Email
    function checkBindingStatus(uid) {
      document.getElementById('loading-text').innerText = "æª¢æŸ¥å¸³è™Ÿç¶å®šä¸­...";
      
      google.script.run
        .withSuccessHandler(function(boundEmail) {
          if (boundEmail) {
            // å·²ç¶å®šï¼šè‡ªå‹•åŸ·è¡ŒæŸ¥è©¢
            console.log("å·²ç¶å®š Email: " + boundEmail);
            document.getElementById('welcome-section').classList.remove('hidden');
            document.getElementById('user-email-display').innerText = boundEmail;
            
            // å‘¼å«å¾Œç«¯æŸ¥è©¢
            callBackendSearch(boundEmail, uid);
          } else {
            // æœªç¶å®šï¼šé¡¯ç¤ºè¼¸å…¥æ¡†
            console.log("æœªç¶å®šï¼Œé¡¯ç¤ºè¼¸å…¥æ¡†");
            hideLoading();
            document.getElementById('login-section').classList.remove('hidden');
          }
        })
        .withFailureHandler(function(err) {
          showError("ç³»çµ±é€£ç·šéŒ¯èª¤ï¼š" + err);
          hideLoading();
        })
        .checkUidLink(uid);
    }

    // 3. ä½¿ç”¨è€…æ‰‹å‹•é»æ“ŠæŸ¥è©¢
    function performSearch() {
      var email = document.getElementById('emailInput').value.trim();
      if (!email) {
        alert("è«‹è¼¸å…¥ Email");
        return;
      }
      
      showLoading("æ­£åœ¨æŸ¥è©¢ä¸¦åŒæ­¥è³‡æ–™...");
      document.getElementById('login-section').classList.add('hidden');
      
      callBackendSearch(email, userUid);
    }

    // 4. å‘¼å«å¾Œç«¯ searchOrdersWithLink
    function callBackendSearch(email, uid) {
      google.script.run
        .withSuccessHandler(showResults)
        .withFailureHandler(function(e){
          showError("æŸ¥è©¢å¤±æ•—ï¼š" + e);
          hideLoading();
          document.getElementById('login-section').classList.remove('hidden');
        })
        .searchOrdersWithLink(email, uid);
    }

    // 5. é¡¯ç¤ºçµæœ
    function showResults(data) {
      hideLoading();
      document.getElementById('welcome-section').classList.add('hidden'); // éš±è—æ­¡è¿è©
      document.getElementById('result-section').classList.remove('hidden');
      
      const container = document.getElementById('orders-container');
      container.innerHTML = "";

      if (!data || data.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">æŸ¥ç„¡è¨‚å–®è³‡æ–™ (æˆ–æ˜¯æ¸¬è©¦æ¨¡å¼ä¸­æœªå›å‚³è³‡æ–™)</div>';
        return;
      }

      // å‹•æ…‹ç”¢ç”Ÿè¨‚å–®å¡ç‰‡ (å‡è¨­å¾Œç«¯å›å‚³æ ¼å¼æ˜¯é™£åˆ—)
      // æ³¨æ„ï¼šä½ éœ€è¦æ ¹æ“šä½ å¯¦éš› Excel è®€å–å¾Œçš„æ¬„ä½é †åºä¾†èª¿æ•´é€™è£¡
      data.forEach(function(row) {
        // å‡è¨­ row[0] æ˜¯è¨‚å–®è™Ÿ, row[1] æ˜¯æ—¥æœŸ, row[2] æ˜¯é‡‘é¡ (è«‹ä¾å¯¦éš›æƒ…æ³èª¿æ•´)
        var cardHtml = `
          <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="m-0 text-primary fw-bold">${row[0] || 'è¨‚å–®'}</h6>
              <span class="badge bg-secondary">${row[1] || ''}</span>
            </div>
            <p class="mb-1 text-muted">${row.join(', ')}</p>
          </div>
        `;
        container.innerHTML += cardHtml;
      });
    }

    // å·¥å…·ï¼šé‡ç½®
    function resetSearch() {
      document.getElementById('result-section').classList.add('hidden');
      document.getElementById('login-section').classList.remove('hidden');
      document.getElementById('emailInput').value = "";
    }

    // å·¥å…·ï¼šé¡¯ç¤ºéŒ¯èª¤
    function showError(msg) {
      var el = document.getElementById('error-msg');
      el.innerText = msg;
      el.classList.remove('hidden');
    }

    // å·¥å…·ï¼šLoading æ§åˆ¶
    function showLoading(text) {
      document.getElementById('loading').classList.remove('hidden');
      if(text) document.getElementById('loading-text').innerText = text;
    }
    
    function hideLoading() {
      document.getElementById('loading').classList.add('hidden');
    }

  </script>
</body>
</html>
