<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ormkub æœƒå“¡å„€è¡¨æ¿</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        /* ç›´æ¥æ²¿ç”¨ä¹‹å‰çš„ CSS æ¨£å¼ */
        :root { --primary-color: #2c3e50; --accent-color: #3498db; --bg-gradient: linear-gradient(135deg, #f6f8fb 0%, #eef2f3 100%); }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg-gradient); min-height: 100vh; padding-bottom: 60px; }
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .custom-card { border: none; border-radius: 16px; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.06); padding: 24px; margin-bottom: 20px; }
        .btn-custom { background: var(--primary-color); color: white; border-radius: 50px; padding: 12px 0; font-weight: 500; }
        .market-item { border-left: 5px solid var(--accent-color); }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3 fw-bold text-secondary" id="loading-text">ç³»çµ±é€£ç·šä¸­...</p>
    </div>

    <div id="app" class="container" style="max-width: 500px;">
        <div class="text-center mt-5 mb-4 fade-in">
            <h4 class="fw-bold" style="color:var(--primary-color);">Ormkub ä»£è³¼æœå‹™</h4>
        </div>

        <div id="register-view" class="custom-card fade-in hidden">
            <h5 class="text-center mb-4 fw-bold">æœƒå“¡ç¶å®š</h5>
            <form onsubmit="event.preventDefault(); doRegister();">
                <div class="mb-3"><input type="email" id="reg-email" class="form-control" placeholder="Email" required></div>
                <div class="mb-3"><input type="text" id="reg-name" class="form-control" placeholder="ç¾¤å…§åç¨± (é‡è¦)" required></div>
                <div class="mb-3"><input type="text" id="reg-receiver" class="form-control" placeholder="æ”¶ä»¶äººå§“å" required></div>
                <div class="mb-3"><input type="tel" id="reg-phone" class="form-control" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼" required></div>
                <div class="mb-3"><input type="text" id="reg-store" class="form-control" placeholder="7-11 é–€å¸‚" required></div>
                <button type="submit" id="reg-btn" class="btn btn-custom w-100">ç¢ºèªç¶å®š</button>
            </form>
        </div>

        <div id="dashboard-view" class="hidden">
            <div class="custom-card fade-in mb-3" style="background: linear-gradient(135deg, #2c3e50, #4ca1af); color: white;">
                <h4>Hi, <span id="user-name">...</span></h4>
                <div class="badge bg-light text-dark opacity-75" id="user-group">...</div>
            </div>
            
            <h6 class="text-muted ms-2 mb-3 fw-bold">å°ˆå±¬è³£å ´</h6>
            <div id="market-list"></div>
            
            <button class="btn btn-outline-secondary w-100 mt-4 rounded-pill" onclick="location.reload()">é‡æ–°æ•´ç†</button>
        </div>
    </div>

    <div class="modal fade" id="infoModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-body" id="infoModalBody"></div><div class="modal-footer"><button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button></div></div></div></div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ==========================================
        // âš™ï¸ ç³»çµ±è¨­å®š (å·²æ›´æ–°)
        // ==========================================
        const CONFIG = {
            // ğŸ”¥ å·²æ›´æ–°ç‚ºä½ æä¾›çš„ç¶²å€
            API_URL: 'https://script.google.com/macros/s/AKfycbw69JlYcBV5vj0yFjxNN1GgiMcQt6xKuym0ANK1tvKdlbnvYTnQ4wgX_dX1IiWIcr08IQ/exec',
            
            // ğŸ”¥ å·²æ›´æ–°ç‚ºä½ çš„ LIFF ID
            LIFF_ID: '2008947743-8h9hmMMW' 
        };

        let currentUid = '';

        window.addEventListener('load', async () => {
            await initLIFF();
        });

        async function initLIFF() {
            try {
                await liff.init({ liffId: CONFIG.LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                
                const profile = await liff.getProfile();
                currentUid = profile.userId;
                console.log('Uid:', currentUid);
                await checkUserStatus(currentUid);
            } catch (err) {
                showMsg('Error', 'LIFF åˆå§‹åŒ–å¤±æ•—: ' + err.message);
                hideLoading();
            }
        }

        async function callApi(action, payload = {}) {
            try {
                // ä½¿ç”¨ POST JSON ç¢ºä¿è³‡æ–™å®Œæ•´
                const response = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action, payload })
                });
                const json = await response.json();
                if (json.status === 'error') throw new Error(json.message);
                return json.data;
            } catch (err) {
                console.error(err);
                throw err;
            }
        }

        async function checkUserStatus(uid) {
            try {
                const user = await callApi('checkUser', { uid });
                hideLoading();
                if (user) {
                    document.getElementById('user-name').textContent = user.name;
                    document.getElementById('user-group').textContent = user.group_name;
                    showView('dashboard-view');
                    loadMarkets(uid);
                } else {
                    showView('register-view');
                }
            } catch (err) {
                hideLoading();
                showMsg('é€£ç·šéŒ¯èª¤', err.message);
            }
        }

        async function doRegister() {
            const email = document.getElementById('reg-email').value;
            const name = document.getElementById('reg-name').value; // ç¾¤å…§åç¨±
            const receiver = document.getElementById('reg-receiver').value;
            const phone = document.getElementById('reg-phone').value;
            const store = document.getElementById('reg-store').value;
            
            showLoading();
            try {
                await callApi('register', { uid: currentUid, email, name, receiver, phone, store });
                await checkUserStatus(currentUid);
            } catch (err) {
                hideLoading();
                showMsg('è¨»å†Šå¤±æ•—', err.message);
            }
        }

        async function loadMarkets(uid) {
            const list = document.getElementById('market-list');
            list.innerHTML = '<div class="text-center text-muted"><small>è¼‰å…¥ä¸­...</small></div>';
            try {
                const markets = await callApi('getMarkets', { uid });
                list.innerHTML = '';
                if (markets.length === 0) {
                    list.innerHTML = '<div class="alert alert-light text-center">ç„¡å°ˆå±¬è³£å ´</div>';
                    return;
                }
                markets.forEach(m => {
                    list.innerHTML += `
                        <div class="custom-card market-item">
                            <h5 class="fw-bold">${m.sheetName}</h5>
                            <p class="text-muted small">${m.desc || ''}</p>
                            <a href="${m.link}" target="_blank" class="btn btn-outline-primary w-100 btn-sm">å‰å¾€ä¸‹å–®</a>
                        </div>
                    `;
                });
            } catch (err) {
                list.innerHTML = '<div class="text-danger small">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
        function showView(id) {
            document.getElementById('register-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById(id).classList.remove('hidden');
        }
        function showMsg(title, msg) {
            document.getElementById('infoModalBody').innerText = msg;
            new bootstrap.Modal(document.getElementById('infoModal')).show();
        }
    </script>
</body>
</html>
