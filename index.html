<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>訂單查詢系統</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{ --card-shadow: 0 10px 28px rgba(0,0,0,.08); }
    body{ background: radial-gradient(1000px 600px at 20% -10%, rgba(13,110,253,.18), transparent 60%),
                  radial-gradient(900px 500px at 100% 0%, rgba(32,201,151,.16), transparent 55%),
                  #0b0f14;
          color:#e9eef5; }
    .wrap{ max-width: 620px; }
    .glass{ background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.12); box-shadow: var(--card-shadow);
            backdrop-filter: blur(10px); border-radius: 18px; }
    .muted{ color: rgba(233,238,245,.72); }
    .chip{ display:inline-flex; align-items:center; gap:.4rem; padding:.35rem .6rem; border-radius:999px;
           background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.12); }
    .hidden{ display:none !important; }
    a{ word-break: break-all; }
    .btn-primary{ box-shadow: 0 10px 22px rgba(13,110,253,.25); }
    .form-control{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.14); color:#fff; }
    .form-control::placeholder{ color: rgba(233,238,245,.55); }
    .form-control:focus{ background: rgba(255,255,255,.10); border-color: rgba(13,110,253,.55); box-shadow: 0 0 0 .25rem rgba(13,110,253,.18); color:#fff; }
    .list-group-item{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.12); color:#e9eef5; }
  </style>
</head>

<body>
  <div class="container wrap py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <div class="fw-semibold" style="letter-spacing:.08em;">訂單整理</div>
        <div class="muted" style="font-size:.95rem;">賣場資訊查詢</div>
      </div>
      <div class="chip" id="statusChip">
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        <span class="muted" id="statusText">自動查詢中…</span>
      </div>
    </div>

    <!-- 未綁定：註冊卡 -->
    <div id="registerCard" class="glass p-4 hidden">
      <div class="mb-2 fw-semibold">首次使用</div>
      <div class="muted mb-4">請輸入 Email 與群內名稱完成綁定</div>

      <div class="mb-3">
        <label class="form-label">Email</label>
        <input id="emailInput" type="email" class="form-control" placeholder="name@example.com" autocomplete="email">
      </div>
      <div class="mb-3">
        <label class="form-label">群內名稱</label>
        <input id="nameInput" type="text" class="form-control" placeholder="你在群裡的名字" autocomplete="name">
      </div>

      <div class="d-grid gap-2">
        <button class="btn btn-primary" onclick="submitRegister()">完成綁定並查詢</button>
        <button class="btn btn-outline-light" onclick="openLineIfNeeded()">回到 LINE</button>
      </div>
      <div class="mt-3 muted" style="font-size:.9rem;">※ 僅用於識別與查詢賣場資訊</div>
    </div>

    <!-- 已綁定：結果卡 -->
    <div id="resultCard" class="glass p-4 hidden">
      <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
        <div class="fw-semibold" id="userName"></div>
        <div class="chip"><span class="muted" id="userMail"></span></div>
      </div>

      <div id="emptyHint" class="alert alert-warning mb-3 hidden" role="alert" style="background: rgba(255,193,7,.14); border-color: rgba(255,193,7,.25); color:#ffe8a6;">
        找不到對應的賣場資訊
      </div>

      <div id="stores" class="list-group"></div>

      
    </div>

    <!-- 錯誤卡 -->
    <div id="errorCard" class="glass p-4 hidden">
      <div class="fw-semibold mb-2">發生錯誤</div>
      <div class="muted" id="errorText"></div>
      <div class="d-grid gap-2 mt-4">
        <button class="btn btn-outline-light" onclick="location.reload()">重新整理</button>
      </div>
    </div>
  </div>

  <script>
    // ====== 設定 ======
    const MY_LIFF_ID = "你的LIFF_ID_填在這裡"; // 必填：部署到 LINE 後請換成你的 LIFF ID

    let userUid = "";

    // ====== UI helper ======
    function setStatus(text, loading=true){
      document.getElementById('statusText').innerText = text;
      const spinner = document.querySelector('#statusChip .spinner-border');
      spinner.classList.toggle('hidden', !loading);
    }

    function showOnly(id){
      ['registerCard','resultCard','errorCard'].forEach(x=>document.getElementById(x).classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    function showError(msg){
      setStatus('');
      document.getElementById('statusChip').classList.add('hidden');
      document.getElementById('errorText').innerText = msg;
      showOnly('errorCard');
    }

    // ====== LIFF init ======
    window.onload = () => init();

    async function init(){
      try{
        setStatus('自動查詢中…', true);

        if(!MY_LIFF_ID){
          // 電腦測試模式（略過 LIFF）
          setStatus('測試模式：請手動填寫', false);
          document.getElementById('statusChip').classList.add('hidden');
          showOnly('registerCard');
          return;
        }

        await liff.init({ liffId: MY_LIFF_ID });

        if(!liff.isLoggedIn()){
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        userUid = profile.userId;

        google.script.run
          .withSuccessHandler(handleInit)
          .withFailureHandler(err => showError('初始化失敗：' + (err && err.message ? err.message : err)))
          .initByUid(userUid);

      }catch(e){
        showError('LIFF 啟動失敗：' + (e && e.message ? e.message : e));
      }
    }

    function handleInit(payload){
      document.getElementById('statusChip').classList.add('hidden');

      if(!payload || !payload.user){
        showOnly('registerCard');
        return;
      }
      renderResult(payload.user, payload.stores || []);
    }

    function renderResult(user, stores){
      document.getElementById('userName').innerText = user.name || '';
      document.getElementById('userMail').innerText = user.mail || '';

      const list = document.getElementById('stores');
      list.innerHTML = '';

      if(!stores || stores.length === 0){
        document.getElementById('emptyHint').classList.remove('hidden');
      }else{
        document.getElementById('emptyHint').classList.add('hidden');
        stores.forEach(item => {
          const a = document.createElement('a');
          a.className = 'list-group-item list-group-item-action';
          a.href = (item.link || '#');
          a.target = '_blank';

          const title = document.createElement('div');
          title.className = 'd-flex justify-content-between align-items-start gap-2';
          title.innerHTML = `
            <div class="fw-semibold">${escapeHtml(item.sheet || '賣場')}</div>
            <span class="badge text-bg-light">開啟</span>
          `;

          const desc = document.createElement('div');
          desc.className = 'muted mt-1';
          desc.style.fontSize = '.95rem';
          desc.innerText = (item.desc || '').toString();

          const link = document.createElement('div');
          link.className = 'mt-2';
          link.style.fontSize = '.9rem';
          link.innerHTML = `<span class="muted">連結：</span> <span>${escapeHtml((item.link || '').toString())}</span>`;

          a.appendChild(title);
          if(item.desc) a.appendChild(desc);
          if(item.link) a.appendChild(link);
          list.appendChild(a);
        });
      }

      showOnly('resultCard');
    }

    function submitRegister(){
      const mail = document.getElementById('emailInput').value.trim();
      const name = document.getElementById('nameInput').value.trim();
      if(!mail){ alert('請輸入 Email'); return; }
      if(!name){ alert('請輸入群內名稱'); return; }

      setStatus('綁定中…', true);
      document.getElementById('statusChip').classList.remove('hidden');

      const uid = userUid || 'TEST_UID';

      google.script.run
        .withSuccessHandler(payload => {
          document.getElementById('statusChip').classList.add('hidden');
          renderResult(payload.user, payload.stores || []);
        })
        .withFailureHandler(err => {
          showError('綁定失敗：' + (err && err.message ? err.message : err));
        })
        .registerAndFetch(mail, name, uid);
    }

    function resetBinding(){
      document.getElementById('emailInput').value = '';
      document.getElementById('nameInput').value = '';
      showOnly('registerCard');
    }

    function openLineIfNeeded(){
      try{ if(2008825521-dLeF3YrA && liff && liff.isInClient()) liff.closeWindow(); }catch(e){}
    }

    function escapeHtml(str){
      return (str || '').toString()
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#039;');
    }
  </script>
</body>
</html>
