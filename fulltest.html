<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´ç³»çµ±æ¸¬è©¦</title>
    <style>
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 15px;
            color: #333;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .log { 
            background: #f8f9fa; 
            padding: 12px; 
            margin: 8px 0; 
            border-radius: 6px;
            border-left: 4px solid #3498db;
            font-size: 14px;
        }
        .error { 
            background: #fee; 
            border-left-color: #e74c3c; 
        }
        .success { 
            background: #efe; 
            border-left-color: #27ae60; 
        }
        .warning { 
            background: #ffeaa7; 
            border-left-color: #fdcb6e; 
        }
        pre { 
            background: #2c3e50; 
            color: #ecf0f1; 
            padding: 10px; 
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
        }
        .user-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
        }
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #229954; }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å®Œæ•´ç³»çµ±æ¸¬è©¦</h1>
        <div id="user-card" style="display:none;" class="user-info">
            <h3>ğŸ‘¤ ç™»å…¥ä½¿ç”¨è€…</h3>
            <div id="user-display"></div>
        </div>
        <div id="logs"></div>
        <div id="actions" style="text-align:center; margin-top:20px;"></div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const LIFF_ID = '2008947743-8h9hmMMW';
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbx_XdnntUyxjevUUF4_zLrqxt649f01Cs6sMt6r94isD2x45iRbTlvriRicP4IpKybUAA/exec';
        
        const logs = document.getElementById('logs');
        const actions = document.getElementById('actions');
        let currentUser = null;

        function addLog(message, type = 'log') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<small><strong>${new Date().toLocaleTimeString()}</strong></small><br>${message}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        }

        function showLoading(text = 'è™•ç†ä¸­...') {
            actions.innerHTML = `<div class="loading"><div class="spinner"></div><p>${text}</p></div>`;
        }

        async function testLIFF() {
            addLog('ğŸ”§ é–‹å§‹æ¸¬è©¦ LIFF åˆå§‹åŒ–...', 'log');
            
            try {
                await liff.init({ liffId: LIFF_ID });
                addLog('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ', 'success');

                if (!liff.isLoggedIn()) {
                    addLog('âš ï¸ æœªç™»å…¥ï¼Œæº–å‚™è·³è½‰...', 'warning');
                    setTimeout(() => liff.login(), 2000);
                    return;
                }

                const profile = await liff.getProfile();
                currentUser = {
                    userId: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl
                };

                document.getElementById('user-card').style.display = 'block';
                document.getElementById('user-display').innerHTML = `
                    <img src="${profile.pictureUrl}" style="width:60px;height:60px;border-radius:50%;border:3px solid white;">
                    <div style="margin-top:10px;">
                        <strong style="font-size:18px;">${profile.displayName}</strong><br>
                        <small>UID: ${profile.userId.substring(0,20)}...</small>
                    </div>
                `;

                addLog('âœ… ä½¿ç”¨è€…ç™»å…¥æˆåŠŸ', 'success');
                addLog(`<pre>${JSON.stringify(currentUser, null, 2)}</pre>`, 'success');

                // é–‹å§‹æ¸¬è©¦ API
                await testAPI();

            } catch (error) {
                addLog('âŒ LIFF åˆå§‹åŒ–å¤±æ•—', 'error');
                addLog(`éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function testAPI() {
            addLog('', 'log');
            addLog('ğŸ“¡ é–‹å§‹æ¸¬è©¦ GAS API é€£ç·š...', 'log');

            // æ¸¬è©¦ 1: checkUser
            try {
                addLog('â³ æ¸¬è©¦ 1/3: æª¢æŸ¥æœƒå“¡ç‹€æ…‹...', 'log');
                showLoading('æª¢æŸ¥æœƒå“¡ä¸­...');

                const checkResult = await callAPI('checkUser', { uid: currentUser.userId });
                
                addLog('âœ… checkUser API å›æ‡‰:', 'success');
                addLog(`<pre>${JSON.stringify(checkResult, null, 2)}</pre>`, 'success');

                if (checkResult) {
                    addLog('ğŸ‰ å·²æ‰¾åˆ°æœƒå“¡è³‡æ–™ï¼', 'success');
                    showMemberActions(checkResult);
                } else {
                    addLog('âš ï¸ æœªè¨»å†Šæœƒå“¡ï¼Œå¯é€²è¡Œè¨»å†Šæ¸¬è©¦', 'warning');
                    showRegisterForm();
                }

            } catch (error) {
                addLog('âŒ checkUser å¤±æ•—', 'error');
                addLog(`éŒ¯èª¤: ${error.message}`, 'error');
                actions.innerHTML = `<button class="btn" onclick="testAPI()">é‡è©¦</button>`;
            }
        }

        async function callAPI(action, payload) {
            addLog(`ğŸ“¤ API è«‹æ±‚: ${action}`, 'log');
            addLog(`<pre>${JSON.stringify(payload, null, 2)}</pre>`, 'log');

            const response = await fetch(GAS_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, payload }),
                mode: 'cors'
            });

            addLog(`ğŸ“¥ HTTP ç‹€æ…‹: ${response.status} ${response.statusText}`, 'log');

            const text = await response.text();
            addLog(`ğŸ“„ åŸå§‹å›æ‡‰ (å‰ 200 å­—): ${text.substring(0, 200)}`, 'log');

            const data = JSON.parse(text);
            
            if (data.status === 'error') {
                throw new Error(data.message);
            }

            return data.data;
        }

        function showMemberActions(member) {
            actions.innerHTML = `
                <div style="text-align:left; background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:15px;">
                    <strong>æœƒå“¡è³‡æ–™:</strong><br>
                    å§“å: ${member.name}<br>
                    ç¾¤çµ„: ${member.group_name}<br>
                    Email: ${member.email}<br>
                    é›»è©±: ${member.phone}<br>
                    é–€å¸‚: ${member.store}
                </div>
                <button class="btn btn-success" onclick="testGetMarkets()">æ¸¬è©¦å–å¾—è³£å ´</button>
                <button class="btn" onclick="location.reload()">é‡æ–°æ¸¬è©¦</button>
            `;
        }

        function showRegisterForm() {
            actions.innerHTML = `
                <div style="text-align:left;">
                    <h3>ğŸ“ è¨»å†Šæ¸¬è©¦</h3>
                    <input type="email" id="email" placeholder="Email" style="width:100%;padding:10px;margin:5px 0;border:1px solid #ddd;border-radius:4px;">
                    <input type="text" id="name" placeholder="ç¾¤å…§åç¨±" style="width:100%;padding:10px;margin:5px 0;border:1px solid #ddd;border-radius:4px;">
                    <input type="text" id="receiver" placeholder="æ”¶ä»¶äºº" style="width:100%;padding:10px;margin:5px 0;border:1px solid #ddd;border-radius:4px;">
                    <input type="tel" id="phone" placeholder="æ‰‹æ©Ÿ 09xxxxxxxx" style="width:100%;padding:10px;margin:5px 0;border:1px solid #ddd;border-radius:4px;">
                    <input type="text" id="store" placeholder="7-11é–€å¸‚" style="width:100%;padding:10px;margin:5px 0;border:1px solid #ddd;border-radius:4px;">
                    <button class="btn btn-success" onclick="testRegister()" style="width:100%;margin-top:10px;">é€å‡ºè¨»å†Š</button>
                </div>
            `;
        }

        async function testRegister() {
            const payload = {
                uid: currentUser.userId,
                email: document.getElementById('email').value,
                name: document.getElementById('name').value,
                receiver: document.getElementById('receiver').value,
                phone: document.getElementById('phone').value,
                store: document.getElementById('store').value
            };

            if (!payload.email || !payload.name || !payload.receiver || !payload.phone || !payload.store) {
                addLog('âŒ è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
                return;
            }

            try {
                addLog('â³ æ¸¬è©¦ 2/3: è¨»å†Šæœƒå“¡...', 'log');
                showLoading('è¨»å†Šä¸­...');

                const result = await callAPI('register', payload);
                
                addLog('âœ… è¨»å†ŠæˆåŠŸï¼', 'success');
                addLog(`<pre>${JSON.stringify(result, null, 2)}</pre>`, 'success');

                // é‡æ–°æª¢æŸ¥æœƒå“¡ç‹€æ…‹
                setTimeout(() => testAPI(), 2000);

            } catch (error) {
                addLog('âŒ è¨»å†Šå¤±æ•—', 'error');
                addLog(`éŒ¯èª¤: ${error.message}`, 'error');
                showRegisterForm();
            }
        }

        async function testGetMarkets() {
            try {
                addLog('â³ æ¸¬è©¦ 3/3: å–å¾—è³£å ´åˆ—è¡¨...', 'log');
                showLoading('è¼‰å…¥è³£å ´ä¸­...');

                const markets = await callAPI('getMarkets', { uid: currentUser.userId });
                
                addLog('âœ… getMarkets API å›æ‡‰:', 'success');
                addLog(`<pre>${JSON.stringify(markets, null, 2)}</pre>`, 'success');

                if (markets && markets.length > 0) {
                    let html = '<div style="text-align:left;"><h3>ğŸ›’ æ‚¨çš„è³£å ´åˆ—è¡¨</h3>';
                    markets.forEach(m => {
                        html += `
                            <div style="background:#f8f9fa;padding:15px;margin:10px 0;border-radius:8px;border-left:4px solid #3498db;">
                                <strong>${m.title}</strong><br>
                                <small>${m.desc}</small><br>
                                <a href="${m.link}" target="_blank" style="color:#3498db;">ğŸ”— ${m.link}</a>
                            </div>
                        `;
                    });
                    html += '</div><button class="btn" onclick="location.reload()">é‡æ–°æ¸¬è©¦</button>';
                    actions.innerHTML = html;
                    addLog(`ğŸ‰ æˆåŠŸè¼‰å…¥ ${markets.length} å€‹è³£å ´`, 'success');
                } else {
                    addLog('âš ï¸ ç›®å‰æ²’æœ‰è³£å ´è³‡æ–™', 'warning');
                    actions.innerHTML = `
                        <div style="padding:20px;background:#ffeaa7;border-radius:8px;">
                            <strong>æç¤º:</strong> è«‹ç¢ºèªä»¥ä¸‹äº‹é …<br>
                            1. Markets è¡¨ä¸­æœ‰è³‡æ–™<br>
                            2. group_name èˆ‡ä½¿ç”¨è€…çš„ group_name ä¸€è‡´<br>
                            3. status æ¬„ä½ç‚º 'active'
                        </div>
                        <button class="btn" onclick="location.reload()">é‡æ–°æ¸¬è©¦</button>
                    `;
                }

            } catch (error) {
                addLog('âŒ å–å¾—è³£å ´å¤±æ•—', 'error');
                addLog(`éŒ¯èª¤: ${error.message}`, 'error');
                actions.innerHTML = `<button class="btn" onclick="testGetMarkets()">é‡è©¦</button>`;
            }
        }

        // å•Ÿå‹•
        window.addEventListener('load', () => {
            addLog('ğŸ“„ é é¢è¼‰å…¥å®Œæˆ', 'log');
            setTimeout(testLIFF, 500);
        });
    </script>
</body>
</html>
