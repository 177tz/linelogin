<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´ç³»çµ±æ¸¬è©¦</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Arial, sans-serif; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            padding: 30px;
            border-radius: 15px;
            color: #333;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .log { 
            background: #f8f9fa; 
            padding: 12px; 
            margin: 8px 0; 
            border-radius: 6px;
            border-left: 4px solid #3498db;
            font-size: 14px;
            word-wrap: break-word;
        }
        .error { 
            background: #fee; 
            border-left-color: #e74c3c; 
        }
        .success { 
            background: #efe; 
            border-left-color: #27ae60; 
        }
        .warning { 
            background: #ffeaa7; 
            border-left-color: #fdcb6e; 
        }
        pre { 
            background: #2c3e50; 
            color: #ecf0f1; 
            padding: 10px; 
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 300px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
        }
        .user-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
            display: inline-block;
        }
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        .btn-success { background: #27ae60; }
        .btn-success:hover { background: #229954; }
        .loading {
            text-align: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å®Œæ•´ç³»çµ±æ¸¬è©¦</h1>
        <p style="text-align:center; color:#666; margin-bottom:20px;">æ›´æ–°æ™‚é–“: 2026/01/25</p>
        
        <div id="user-card" style="display:none;" class="user-info">
            <h3>ğŸ‘¤ ç™»å…¥ä½¿ç”¨è€…</h3>
            <div id="user-display"></div>
        </div>
        
        <div id="logs"></div>
        <div id="actions" style="text-align:center; margin-top:20px;"></div>
    </div>

    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const LIFF_ID = '2008947743-8h9hmMMW';
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbx_XdnntUyxjevUUF4_zLrqxt649f01Cs6sMt6r94isD2x45iRbTlvriRicP4IpKybUAA/exec';
        
        const logs = document.getElementById('logs');
        const actions = document.getElementById('actions');
        let currentUser = null;

        function addLog(message, type = 'log') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<small><strong>${new Date().toLocaleTimeString()}</strong></small><br>${message}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${type}]`, message);
        }

        function showLoading(text = 'è™•ç†ä¸­...') {
            actions.innerHTML = `<div class="loading"><div class="spinner"></div><p>${text}</p></div>`;
        }

        // ä¸»è¦æµç¨‹
        async function init() {
            addLog('ğŸš€ ç³»çµ±å•Ÿå‹•', 'log');
            addLog(`ğŸ“± LIFF ID: ${LIFF_ID}`, 'log');
            addLog(`ğŸŒ ç•¶å‰ç¶²å€: ${window.location.href}`, 'log');
            
            // æª¢æŸ¥ LIFF SDK æ˜¯å¦è¼‰å…¥
            if (typeof liff === 'undefined') {
                addLog('âŒ LIFF SDK æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š', 'error');
                return;
            }
            addLog('âœ… LIFF SDK å·²è¼‰å…¥', 'success');

            try {
                addLog('â³ æ­£åœ¨åˆå§‹åŒ– LIFF...', 'log');
                
                // åˆå§‹åŒ– LIFF
                await liff.init({ liffId: LIFF_ID });
                
                addLog('âœ… LIFF åˆå§‹åŒ–æˆåŠŸï¼', 'success');
                addLog(`ğŸ“ åŸ·è¡Œç’°å¢ƒ: ${liff.isInClient() ? 'LINE App å…§' : 'å¤–éƒ¨ç€è¦½å™¨'}`, 'log');

                // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                if (!liff.isLoggedIn()) {
                    addLog('âš ï¸ æœªç™»å…¥ï¼Œ3ç§’å¾Œè·³è½‰è‡³ç™»å…¥é é¢...', 'warning');
                    showLoading('æº–å‚™ç™»å…¥...');
                    setTimeout(() => {
                        liff.login();
                    }, 3000);
                    return;
                }

                addLog('âœ… å·²ç™»å…¥ LINE å¸³è™Ÿ', 'success');

                // å–å¾—ä½¿ç”¨è€…è³‡æ–™
                const profile = await liff.getProfile();
                currentUser = {
                    userId: profile.userId,
                    displayName: profile.displayName,
                    pictureUrl: profile.pictureUrl
                };

                addLog('âœ… å–å¾—ä½¿ç”¨è€…è³‡æ–™æˆåŠŸ', 'success');
                addLog(`<pre>${JSON.stringify(currentUser, null, 2)}</pre>`, 'success');

                // é¡¯ç¤ºä½¿ç”¨è€…å¡ç‰‡
                document.getElementById('user-card').style.display = 'block';
                document.getElementById('user-display').innerHTML = `
                    <img src="${profile.pictureUrl}" style="width:60px;height:60px;border-radius:50%;border:3px solid white;">
                    <div style="margin-top:10px;">
                        <strong style="font-size:18px;">${profile.displayName}</strong><br>
                        <small>UID: ${profile.userId.substring(0,20)}...</small>
                    </div>
                `;

                // é–‹å§‹æ¸¬è©¦ API
                await testCheckUser();

            } catch (error) {
                addLog('âŒ LIFF åˆå§‹åŒ–å¤±æ•—', 'error');
                addLog(`éŒ¯èª¤é¡å‹: ${error.name}`, 'error');
                addLog(`éŒ¯èª¤è¨Šæ¯: ${error.message}`, 'error');
                
                // è©³ç´°éŒ¯èª¤è³‡è¨Š
                if (error.code) {
                    addLog(`éŒ¯èª¤ä»£ç¢¼: ${error.code}`, 'error');
                }
                
                // æä¾›è§£æ±ºå»ºè­°
                if (error.message.includes('400')) {
                    addLog('ğŸ’¡ å¯èƒ½åŸå› : LIFF ID ä¸æ­£ç¢º', 'warning');
                    addLog('è«‹åˆ° LINE Developers Console ç¢ºèª LIFF ID', 'warning');
                } else if (error.message.includes('403')) {
                    addLog('ğŸ’¡ å¯èƒ½åŸå› : Endpoint URL è¨­å®šéŒ¯èª¤', 'warning');
                    addLog(`æ‡‰è¨­å®šç‚º: ${window.location.origin}${window.location.pathname}`, 'warning');
                }

                actions.innerHTML = '<button class="btn" onclick="location.reload()">é‡æ–°è¼‰å…¥</button>';
            }
        }

        // API å‘¼å«å‡½æ•¸
        async function callAPI(action, payload) {
            addLog(`ğŸ“¤ API è«‹æ±‚: ${action}`, 'log');
            addLog(`ğŸ“¦ Payload: <pre>${JSON.stringify(payload, null, 2)}</pre>`, 'log');

            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, payload }),
                    mode: 'cors',
                    redirect: 'follow'
                });

                addLog(`ğŸ“¥ HTTP ç‹€æ…‹: ${response.status} ${response.statusText}`, 'log');

                const text = await response.text();
                addLog(`ğŸ“„ åŸå§‹å›æ‡‰ (å‰ 500 å­—): <pre>${text.substring(0, 500)}</pre>`, 'log');

                let data;
                try {
                    data = JSON.parse(text);
                } catch (parseError) {
                    addLog('âŒ å›æ‡‰ä¸æ˜¯æœ‰æ•ˆçš„ JSON', 'error');
                    throw new Error('API å›æ‡‰æ ¼å¼éŒ¯èª¤');
                }

                addLog(`ğŸ“Š è§£æå¾Œçš„è³‡æ–™: <pre>${JSON.stringify(data, null, 2)}</pre>`, 'log');

                if (data.status === 'error') {
                    throw new Error(data.message || 'API å›å‚³éŒ¯èª¤');
                }

                return data.data;

            } catch (error) {
                addLog(`âŒ API å‘¼å«å¤±æ•—: ${error.message}`, 'error');
                throw error;
            }
        }

        // æ¸¬è©¦ 1: æª¢æŸ¥æœƒå“¡
        async function testCheckUser() {
            addLog('', 'log');
            addLog('========== æ¸¬è©¦ 1/3: æª¢æŸ¥æœƒå“¡ç‹€æ…‹ ==========', 'log');
            showLoading('æª¢æŸ¥æœƒå“¡ä¸­...');

            try {
                const user = await callAPI('checkUser', { uid: currentUser.userId });

                if (user) {
                    addLog('âœ… æ‰¾åˆ°æœƒå“¡è³‡æ–™ï¼', 'success');
                    addLog(`<pre>${JSON.stringify(user, null, 2)}</pre>`, 'success');
                    showMemberActions(user);
                } else {
                    addLog('âš ï¸ æœªè¨»å†Šæœƒå“¡', 'warning');
                    showRegisterForm();
                }

            } catch (error) {
                addLog('âŒ æª¢æŸ¥æœƒå“¡å¤±æ•—', 'error');
                actions.innerHTML = '<button class="btn" onclick="testCheckUser()">é‡è©¦</button>';
            }
        }

        // é¡¯ç¤ºæœƒå“¡æ“ä½œ
        function showMemberActions(member) {
            actions.innerHTML = `
                <div style="text-align:left; background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:15px;">
                    <strong style="font-size:16px;">ğŸ“‹ æœƒå“¡è³‡æ–™</strong><br><br>
                    <strong>å§“å:</strong> ${member.name || 'æœªè¨­å®š'}<br>
                    <strong>ç¾¤çµ„:</strong> ${member.group_name || 'æœªè¨­å®š'}<br>
                    <strong>Email:</strong> ${member.email || 'æœªè¨­å®š'}<br>
                    <strong>é›»è©±:</strong> ${member.phone || 'æœªè¨­å®š'}<br>
                    <strong>é–€å¸‚:</strong> ${member.store || 'æœªè¨­å®š'}
                </div>
                <button class="btn btn-success" onclick="testGetMarkets()">æ¸¬è©¦å–å¾—è³£å ´</button>
                <button class="btn" onclick="location.reload()">é‡æ–°æ¸¬è©¦</button>
            `;
        }

        // é¡¯ç¤ºè¨»å†Šè¡¨å–®
        function showRegisterForm() {
            actions.innerHTML = `
                <div style="text-align:left;">
                    <h3 style="margin-bottom:15px;">ğŸ“ æ¸¬è©¦è¨»å†ŠåŠŸèƒ½</h3>
                    <input type="email" id="email" placeholder="Email" required>
                    <input type="text" id="name" placeholder="ç¾¤å…§åç¨± (ä¾‹å¦‚: ä¸€èˆ¬æœƒå“¡)" required>
                    <input type="text" id="receiver" placeholder="æ”¶ä»¶äººå§“å" required>
                    <input type="tel" id="phone" placeholder="æ‰‹æ©Ÿè™Ÿç¢¼ (09xxxxxxxx)" maxlength="10" required>
                    <input type="text" id="store" placeholder="7-11 é–€å¸‚åç¨±" required>
                    <button class="btn btn-success" onclick="testRegister()" style="width:100%; margin-top:10px;">é€å‡ºè¨»å†Š</button>
                    <p style="font-size:12px; color:#666; margin-top:10px;">
                        âš ï¸ æ³¨æ„: group_name (ç¾¤å…§åç¨±) å¿…é ˆèˆ‡ Markets è¡¨ä¸­çš„ group_name å®Œå…¨ä¸€è‡´æ‰èƒ½çœ‹åˆ°è³£å ´
                    </p>
                </div>
            `;
        }

        // æ¸¬è©¦ 2: è¨»å†Š
        async function testRegister() {
            const payload = {
                uid: currentUser.userId,
                email: document.getElementById('email').value.trim(),
                name: document.getElementById('name').value.trim(),
                receiver: document.getElementById('receiver').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                store: document.getElementById('store').value.trim()
            };

            // é©—è­‰
            if (!payload.email || !payload.name || !payload.receiver || !payload.phone || !payload.store) {
                addLog('âŒ è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½', 'error');
                return;
            }

            if (!/^09\d{8}$/.test(payload.phone)) {
                addLog('âŒ æ‰‹æ©Ÿæ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥ 09xxxxxxxx', 'error');
                return;
            }

            try {
                addLog('', 'log');
                addLog('========== æ¸¬è©¦ 2/3: è¨»å†Šæœƒå“¡ ==========', 'log');
                showLoading('è¨»å†Šä¸­...');

                const result = await callAPI('register', payload);
                
                addLog('âœ… è¨»å†ŠæˆåŠŸï¼', 'success');
                addLog(`<pre>${JSON.stringify(result, null, 2)}</pre>`, 'success');

                // 2ç§’å¾Œé‡æ–°æª¢æŸ¥æœƒå“¡ç‹€æ…‹
                addLog('â³ 2ç§’å¾Œé‡æ–°æª¢æŸ¥æœƒå“¡ç‹€æ…‹...', 'log');
                setTimeout(() => testCheckUser(), 2000);

            } catch (error) {
                addLog('âŒ è¨»å†Šå¤±æ•—', 'error');
                showRegisterForm();
            }
        }

        // æ¸¬è©¦ 3: å–å¾—è³£å ´
        async function testGetMarkets() {
            try {
                addLog('', 'log');
                addLog('========== æ¸¬è©¦ 3/3: å–å¾—è³£å ´åˆ—è¡¨ ==========', 'log');
                showLoading('è¼‰å…¥è³£å ´ä¸­...');

                const markets = await callAPI('getMarkets', { uid: currentUser.userId });
                
                addLog('âœ… getMarkets API å›æ‡‰æˆåŠŸ', 'success');
                addLog(`<pre>${JSON.stringify(markets, null, 2)}</pre>`, 'success');

                if (markets && markets.length > 0) {
                    let html = '<div style="text-align:left;"><h3 style="margin-bottom:15px;">ğŸ›’ æ‚¨çš„è³£å ´åˆ—è¡¨</h3>';
                    markets.forEach((m, index) => {
                        html += `
                            <div style="background:#f8f9fa;padding:15px;margin:10px 0;border-radius:8px;border-left:4px solid #3498db;">
                                <strong>${index + 1}. ${m.title || 'æœªå‘½åè³£å ´'}</strong><br>
                                <small style="color:#666;">${m.desc || 'ç„¡æè¿°'}</small><br>
                                <a href="${m.link}" target="_blank" style="color:#3498db; text-decoration:none;">ğŸ”— ${m.link}</a>
                            </div>
                        `;
                    });
                    html += '</div><button class="btn" onclick="location.reload()" style="margin-top:15px;">é‡æ–°æ¸¬è©¦</button>';
                    actions.innerHTML = html;
                    
                    addLog(`ğŸ‰ æˆåŠŸè¼‰å…¥ ${markets.length} å€‹è³£å ´`, 'success');
                } else {
                    addLog('âš ï¸ ç›®å‰æ²’æœ‰è³£å ´è³‡æ–™', 'warning');
                    actions.innerHTML = `
                        <div style="padding:20px;background:#ffeaa7;border-radius:8px;">
                            <strong>âš ï¸ æ‰¾ä¸åˆ°è³£å ´è³‡æ–™</strong><br><br>
                            è«‹æª¢æŸ¥ä»¥ä¸‹äº‹é …ï¼š<br>
                            1. Markets è¡¨ (ID: 1Bu7v-Zy6Vu_al0hPmRE8PsMZW4tBT5_DsGzU42xh8cU) æ˜¯å¦æœ‰è³‡æ–™<br>
                            2. Markets è¡¨çš„ <strong>group_name</strong> æ˜¯å¦èˆ‡æ‚¨çš„ç¾¤çµ„åç¨±ä¸€è‡´<br>
                            3. Markets è¡¨çš„ <strong>status</strong> æ¬„ä½æ˜¯å¦ç‚º 'active'<br>
                            4. GAS æ˜¯å¦æœ‰ Markets è¡¨çš„è®€å–æ¬Šé™
                        </div>
                        <button class="btn" onclick="testGetMarkets()" style="margin-top:10px;">é‡è©¦</button>
                        <button class="btn" onclick="location.reload()">é‡æ–°æ¸¬è©¦</button>
                    `;
                }

            } catch (error) {
                addLog('âŒ å–å¾—è³£å ´å¤±æ•—', 'error');
                actions.innerHTML = `
                    <button class="btn" onclick="testGetMarkets()">é‡è©¦</button>
                    <button class="btn" onclick="location.reload()">é‡æ–°æ¸¬è©¦</button>
                `;
            }
        }

        // é é¢è¼‰å…¥æ™‚å•Ÿå‹•
        window.addEventListener('load', () => {
            addLog('ğŸ“„ é é¢è¼‰å…¥å®Œæˆ', 'log');
            // å»¶é² 500ms ç¢ºä¿ LIFF SDK å®Œå…¨è¼‰å…¥
            setTimeout(init, 500);
        });

        // éŒ¯èª¤æ•æ‰
        window.addEventListener('error', (e) => {
            addLog(`âŒ å…¨åŸŸéŒ¯èª¤: ${e.message}`, 'error');
            console.error('Global error:', e);
        });
    </script>
</body>
</html>
